<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Gitlab 安装</title>
    <url>/2023/04/09/%E8%BF%90%E7%BB%B4/gitlab%20%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[目录安装
gitlab 运行需要较大内存，建议将虚拟机内存设置为 4GB 以上，并保证相关端口不被其他进行占用。

安装相关依赖yum -y install policycoreutils openssh-server openssh-clients postfix

设置 postfix
设置 postfix 为开机自启动，目的：支持 gitlab 邮件发送。

systemctl enable postfix &amp;&amp; systemctl start postfix

rpm 包安装官方参考链接：https://packages.gitlab.com/gitlab/gitlab-ce/install#bash-rpm
使用以下命令进行快速安装：
curl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash


EL 是 Red Hat Enterprise Linux 的简写 

EL6 软件包用于在 Red Hat 6.x, CentOS 6.x, and CloudLinux 6.x 的安装。
EL5 软件包用于在 Red Hat 5.x, CentOS 5.x, CloudLinux 5.x 的安装。
EL7 软件包用于在 Red Hat 7.x, CentOS 7.x, and CloudLinux 7.x 的安装。


所以这里我们采用安装 EL7 的模式，安装命令如下：
官方参考链接：https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/7/gitlab-ce-15.8.5-ce.0.el7.x86_64.rpm
sudo yum -y install gitlab-ce-15.8.5-ce.0.el7.x86_64

安装完毕后的主体文件都在 /opt/gitlab/ 目录下，可自行翻阅按需修改。
修改 root 密码官方修改密码：(http://docs.gitlab.com/ce/security/reset_root_password.html)
在root用户下，执行
# 老版命令gitlab-rails console production# 新版命令gitlab-rails console -e production

获得用户数据，修改用户密码
[root@svr34 bin]# gitlab-rails console productionLoading production environment (Rails 4.2.5.2)irb(main):001:0&gt; user = User.where(id: 1).first=&gt; #&lt;User id:1 @root&gt;irb(main):002:0&gt; user.password=&quot;7613302589&quot;=&gt; &quot;12345678&quot;irb(main):003:0&gt; user.password_confirmation=&quot;7613302589&quot;=&gt; &quot;12345678&quot;irb(main):004:0&gt; user.save!=&gt; trueirb(main):005:0&gt; quit

修改访问 URL编辑 gitlab.rb 文件。
# vim /etc/gitlab/gitlab.rbexternal_url &#x27;http://192.168.50.245:8138&#x27;


此处注意别使用已被占用的端口！（如8080）



重置并启动 Gitlab重置：

注：第一次预计需要几分钟

gitlab-ctl reconfigure

启动：
gitlab-ctl restart

端口用途一览




端口号
归类
用途



8060
Nginx
用途不明


8138
Nginx
第二个 nginx 的端口，就是 gitlab 实例的主端口，所有外部访问的 http 均通过 gitlab 内置的 nginx 服务器处理，并使用该端口，当然暴露地址为外网0.0.0.0


9121
Redis
redis_exporter 的 9121，是 gitlab 内置 redis 数据库，只向本机暴露


9090
Prometheus
向本机暴露，用途应该是创建和管理时间序列事件的触发，如通知那些功能


9187
PostgreSQL
postgres_expoter 的9187，是 gitlab 内置的 postegres 数据库，向本机暴露


9093
Ruby
config.ru 的 9093，gitlab 使用 ruby 的 unicorn 作为 app server 运行，管理 worker 等功能，比较重要，默认为 8080，由于 8080 比较受欢迎，这个端口基本上都得改，暴露可自行设定；


9168
Ruby
用途不明


9100
NodeJS
node_exporter 的 9100，一个 nodejs 进程，用于实现测量所在的机器的资源状态比如cpu、内存、硬盘等数据的功能


9229
Go
gitlab-workhors 的 9229，一个是用 go 语言写的组件，是 gitlab 发展途中添加进来的用于优化 git over http 的组件，具体历史可以查看这里了解gitlab-workhors的由来


8082
其他
sidekiq 的 8082，是一种多线程后台处理系统，用于实现 gitlab 异步运行任务


9236
其他
gitaly 的9236，是一个能够提供访问 git 仓库的 RPC 远程调用功能的服务，属于 gitlab 的一个托管组件gitlab 的配置文件位于/etc/gitlab/gitlab/gitlab.rb，使用vim等工具可以直接修改，各种参数配置修改可以参考官方文档







nginx 代理关闭 selinux
什么是selinux ？
SELinux：即安全增强型 Linux（Security-Enhanced Linux）
它是一个 Linux 内核模块，也是 Linux 的一个安全子系统
它主要由美国国家安全局开发，主要作用是最大限度地减小系统中服务进程可访问的资源（最小权限原则）
为什么要关闭 selinux ？
有的软件对于 selinux 的安全规则支持不够好，就会建议在安装前把 selinux 先关闭，例如 k8s，本次在启动 nginx 的过程中发现 gitlab 会报 502 的错误，经由使用 journalctl -xe  命令发现有 selinux 的相关错误信息，所以需要把 selinux 做一次人工的手动禁用。
selinux 常用命令：
# 查看审计日志cat /var/log/audit/audit.log# 分析一个文件sealert -a /var/log/audit/audit.log# 查询系统中的布尔型规则及其状态getsebool -a

selinux的三种运行模式:

enforcing: 强制模式，SELinux 正在运行中，已经在限制 domain&#x2F;type
permissive: 宽容模式：SELinux 正在运行中，但仅发出警告信息,并不会实际限制 domain&#x2F;type 的存取（permissive模式可以用在测试环境中供调试规则时使用）
disabled: 关闭，SELinux 没有实际运行。

sestatus -v # 查看当前信息getenforce # 查看当前运行模式

临时关闭# 0: Permissive# 1: Enforcingsetenforce 0

永久关闭# vim /etc/selinux/configSELINUX=disabled

外部 nginx 安装添加 Nginx 到 YUM 源
sudo rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm

安装 nginx
sudo yum install -y nginx

启用 nginx
sudo systemctl enable nginx.service &amp;&amp; sudo systemctl start nginx.service

Nginx 常用配置目录如下：
# 资源文件目录/usr/share/nginx/html/├── 50x.html└── index.html# 配置文件主目录/etc/nginx/├── conf.d│   ├── default.conf│   └── gitlab.conf # gitlab 配置文件├── fastcgi_params├── mime.types├── modules├── nginx.conf # nginx 根目录配置文件├── scgi_params└── uwsgi_params

代理 gitlab 内部 nginxgitlab 服务器主体框架如下：


nginx 配置文件gitlab.conf 配置文件内容如下：
# 主访问入口server &#123;  listen 80;  server_name gitlab.yahya.top;  # 入口反向代理  location / &#123;    proxy_set_header Host $host;    proxy_set_header X-Real-IP $remote_addr;    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;    proxy_redirect off;    # 配置反向代理地址    proxy_pass http://192.168.50.245:8138;    proxy_http_version 1.1;    # 一定记得要配置 body_size    client_max_body_size 1024m;  &#125;&#125;

修改 gitlab.rb 文件

external_url 的配置直接影响到 gitlab 系统中所有 http 入口的地址，比如 git 仓库的 http 地址，gitlab 访问页面的地址，注册回调的地址，邮件验证的地址等。

编辑 gitlab.rb 文件
vim /etc/gitlab/gitlab.rb

配置域名external_url &#x27;http://gitlab.yahya.top&#x27;

修改对外主端口nginx[&#x27;listen_port&#x27;] = 8138

max_body_size 配置gitlab 是可以使用 http 和 ssh 两种方式来进行git操作的，当使用 http 时，是通过post请求发送内容，若 nginx 在代理时没有设置 body_size 时将会收到：413 Request Entity Too Large 的错误，push 不了代码，内外部的 nginx 都需要配置，在 gitlab.rb 中添加：
nginx[&#x27;client_max_body_size&#x27;] = &#x27;1024m&#x27;

认证普通用户
默认情况下注册的用户是需要进行审批，否则在没有审批的情况下登录会报以下的错误：
Your account is pending approval from your GitLab administrator and hence bl

登录 root 用户，点击头像这里


点击 Overview -&gt; Users -&gt; Pending approval，审批需要注册的用户即可。


临时关闭分支保护
git push 报错 pre-receive hook declined，原因为 master 为受保护分支，无法强推代码到 master 分支上。使用 Owner 以及 Admin 角色账号推送都无法成功。

Settings -&gt; Repository -&gt; Protected Branches 临时 Unprotect master 分支(强推成功后一定要重新添加为受保护的分支)


关于 GitLab 访问权限
访问权限 - Visibility Level：
这个是在建立项目时就需要选定的，主要用于决定哪些人可以访问此项目，包含 3 种：

Private - 私有，只有属于该项目成员才有看到
Internal - 内部，用 GitLab 账号的人都看到
Public - 公开，任何人可以看到

开源项目和组设置的是 Internal。
行为权限：
在满足行为权限之前，必须具备访问权限（如果没有访问权限，那就无所谓行为权限了），行为权限是指对该项目进行某些操作，比如提交、创建问题、创建新分支、删除分支、创建标签、删除标签等角色。

官方权限解释文档：https://docs.gitlab.com/ee/user/permissions.html#project-members-permissions


Guest - 访客
可以创建 issue、发表评论，不能读写版本库。

Reporter  - 报告者
可以理解为测试员、产品经理等，一般负责提交 issue 等 可以克隆代码，不能提交，QA、PM 可以赋予这个权限。

Developer - 开发者
可以克隆代码、开发、提交、push，RD 可以赋予这个权限。

Master - 主人
可以创建项目、添加 tag、保护分支、添加项目成员、编辑项目，核心 RD 负责人可以赋予这个权限。

Owner - 拥有者
可以设置项目访问权限 - Visibility Level、删除项目、迁移项目、管理组成员，开发组 Leader 可以赋予这个权限。

Maintainer - 维护者
权限与 Owner 差不多，但无删除项目等权限。


参见错误502 错误：
首先保证Gitlab可用运行内存大于 4G，端口未被占用
再赋予权限：
chmod -R 755 /var/log/gitlab

再重置重启，访问后仍然可能遇到502，不过我刷新2次就一切ok了。
参考文章使用Nginx搭建并代理GitLab服务器
Centos7 搭建Gitlab服务器并配置项目全过程
gitlab配置域名并https访问
linux(centos8):禁用selinux(临时关闭&#x2F;永久关闭)
]]></content>
      <categories>
        <category>运维</category>
        <category>gitlab</category>
      </categories>
      <tags>
        <tag>gitlab1</tag>
      </tags>
  </entry>
</search>
