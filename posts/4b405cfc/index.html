<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Yahya"><meta name="keywords" content=""><meta name="description" content="多线程设计模式概念线程的终止Java程序的终止是指除守护进程以外的线程全部终止。 竞态条件线程之间由于相互竞争而引起的与预期相反的情况称为数据竞争（data race）或竞态条件（race condition）。 监视线程的互斥机制称为监视（monitor）。另外，获取锁有时也叫做“拥有监视”或“持有锁”。 当前线程是否已获取某一对象的锁可以通过Thread.holdsLock方法来确认。当前线程"><meta property="og:type" content="article"><meta property="og:title" content="Java 多线程设计模式"><meta property="og:url" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/index.html"><meta property="og:site_name" content="yahya的博客"><meta property="og:description" content="多线程设计模式概念线程的终止Java程序的终止是指除守护进程以外的线程全部终止。 竞态条件线程之间由于相互竞争而引起的与预期相反的情况称为数据竞争（data race）或竞态条件（race condition）。 监视线程的互斥机制称为监视（monitor）。另外，获取锁有时也叫做“拥有监视”或“持有锁”。 当前线程是否已获取某一对象的锁可以通过Thread.holdsLock方法来确认。当前线程"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/37.jpg"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/38.jpg"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/39.jpg"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/46.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/47.jpg"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/48.jpg"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/49.jpg"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/50.jpg"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/53.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/54.jpg"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/55.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/57.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/56.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/58.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/59.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/60.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/61.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/62.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/63.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/64.jpg"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/67.jpg"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/65.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/66.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/68.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/69.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/72.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/73.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/74.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/70.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/71.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/75.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/76.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/77.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/78.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/79.png"><meta property="og:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/80.png"><meta property="article:published_time" content="2023-04-16T15:55:17.664Z"><meta property="article:modified_time" content="2023-04-16T15:55:17.664Z"><meta property="article:author" content="Yahya"><meta property="article:tag" content="多线程"><meta property="article:tag" content="设计"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://blog.yahyav2rayssr.top/posts/4b405cfc/37.jpg"><title>Java 多线程设计模式 - yahya的博客</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"blog.yahyav2rayssr.top",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!1,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!1,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:6},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="yahya的博客" type="application/atom+xml"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Yahya的博客</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Java 多线程设计模式"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-04-16 23:55" pubdate>2023年4月16日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 58k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 485 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Java 多线程设计模式</h1><div class="markdown-body"><h1 id="多线程设计模式"><a href="#多线程设计模式" class="headerlink" title="多线程设计模式"></a>多线程设计模式</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><h3 id="线程的终止"><a href="#线程的终止" class="headerlink" title="线程的终止"></a>线程的终止</h3><p>Java程序的终止是指除守护进程以外的线程全部终止。</p><h3 id="竞态条件"><a href="#竞态条件" class="headerlink" title="竞态条件"></a>竞态条件</h3><p>线程之间由于相互竞争而引起的与预期相反的情况称为数据竞争（data race）或竞态条件（race condition）。</p><h3 id="监视"><a href="#监视" class="headerlink" title="监视"></a>监视</h3><p>线程的互斥机制称为<strong>监视</strong>（monitor）。另外，获取锁有时也叫做“拥有监视”或“持有锁”。</p><p>当前线程是否已获取某一对象的锁可以通过Thread.holdsLock方法来确认。当前线程已获取对象obj的锁时，可使用assert来像下面表示出来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">assert</span> Thread.holdsLock(obj)<br></code></pre></td></tr></table></figure><h2 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h2><p>HashTable中的所有方法都采用Single Threaded Execution模式，而ConcurrentHashMap则将内部数据结构分成多段，针对各段操作的线程互不相干，因而也就无需针对其他线程执行互斥处理。这样看来，HashTable更容易发生线程冲突。</p><p><strong><code>java.util.concurrent.CocurrentHashMap</code>接口是通过分割内部数据结构防止线程冲突的Map。</strong></p><h2 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h2><p>Semaphore是一种基于计数的信号量。它可以设定一个阈值，基于此，多个线程竞争获取许可信号，做完自己的申请后归还，超过阈值后，线程申请许可信号将会被阻塞。Semaphore可以用来构建一些对象池，资源池之类的，比如数据库连接池，我们也可以创建计数为1的Semaphore，将其作为一种类似互斥锁的机制，这也叫二元信号量，表示两种互斥状态。</p><p>资源的许可个数（permits）将通过Semaphore的构造函数来确定。</p><ul><li>Semaphore的acquire方法用于确保存在可用资源。</li><li>Semephore的release方法用户释放资源。</li></ul><p>示例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Log</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printLn</span><span class="hljs-params">(String s)</span> &#123;<br>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;: &quot;</span> + s);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BoundedResource</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Semaphore semaphore;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>(<span class="hljs-number">314159</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BoundedResource</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>)</span> &#123;<br>        <span class="hljs-built_in">this</span>.semaphore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-keyword">permits</span>);<br>        <span class="hljs-built_in">this</span>.<span class="hljs-keyword">permits</span> = <span class="hljs-keyword">permits</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">use</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        semaphore.acquire();<br>        <span class="hljs-keyword">try</span> &#123;<br>            doUse();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            semaphore.release();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doUse</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        Log.printLn(<span class="hljs-string">&quot;BEGIN: used = &quot;</span> + (<span class="hljs-keyword">permits</span> - semaphore.availablePermits()));<br>        Thread.sleep(random.nextInt(<span class="hljs-number">500</span>));<br>        Log.printLn(<span class="hljs-string">&quot;END: used = &quot;</span> + (<span class="hljs-keyword">permits</span> - semaphore.availablePermits()));<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>(<span class="hljs-number">26344</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BoundedResource resource;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserThread</span><span class="hljs-params">(BoundedResource resource)</span> &#123;<br>        <span class="hljs-built_in">this</span>.resource = resource;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                resource.use();<br>                Thread.sleep(random.nextInt(<span class="hljs-number">3000</span>));<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">BoundedResource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BoundedResource</span>(<span class="hljs-number">3</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserThread</span>(resource).start();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Before-x2F-After模式"><a href="#Before-x2F-After模式" class="headerlink" title="Before&#x2F;After模式"></a>Before&#x2F;After模式</h2><p>before&#x2F;After模式主要在于finally的引入。</p><h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> &#123;<br>    lock();<br>    <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//	业务逻辑</span><br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        unlock();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ThreadFactory"><a href="#ThreadFactory" class="headerlink" title="ThreadFactory"></a>ThreadFactory</h2><p>ThreadFactory翻译过来是线程工厂，顾名思义，就是用来创建线程的，它用到了工厂模式的思想。它通常和线程池一起使用，主要用来控制创建新线程时的一些行为，比如设置线程的优先级，名字等等。</p><p>示例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ThreadFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> Executors.defaultThreadFactory();<br>        factory.newThread(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Printer</span>(<span class="hljs-string">&quot;Nice!&quot;</span>)).start();<br>        factory.newThread(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Printer</span>(<span class="hljs-string">&quot;Bitch!&quot;</span>)).start();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Good&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>单线程程序中使用synchronized方法并不会破坏程序的安全性。但是，调用synchronized方法要比调用一般方法花费时间，这会稍微降低程序性能。</p></blockquote><blockquote><p>long，double的赋值和引用操作并不是原子的。总结如下：</p><ul><li>基本类型、引用类型的赋值和引用是原子操作。</li><li>long和double的赋值和引用是非原子操作。</li><li>long或double在线程间共享时，需要将其放入synchronized中操作，或者声明为volatile。</li></ul></blockquote><blockquote><p>字符串和实例表达式通过运算符“+”连接时，程序会自动调用实例表达式的toString()方法。</p></blockquote><blockquote><p>Thread.yield并不会释放锁。</p></blockquote><h2 id="Single-Threaded-Execution模式"><a href="#Single-Threaded-Execution模式" class="headerlink" title="Single Threaded Execution模式"></a>Single Threaded Execution模式</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>Single Threaded Execution模式主要是用于确保同一时间内只能让一个线程执行处理，说通俗点就是对synchronized的标准化使用方式，这是比较基础的。</p><h3 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h3><p>Single Threaded Execution 模式的角色如下：</p><p>SharedResource(共享资源)参与者<br>SharedResource就是多线线程会同时访问的资源类，该类通常具有2类方法：<br>①SafeMethod——从多个线程同时调用也不会发生问题的方法<br>②UnsafeMethod——从多个线程同时调用会发生问题，这类方法需要加以防护，指定只能由单线程访问区域，即临界区（critical section）。</p><img src="/posts/4b405cfc/37.jpg" srcset="/img/loading.gif" lazyload style="zoom:67%"><h2 id="Immutable模式"><a href="#Immutable模式" class="headerlink" title="Immutable模式"></a>Immutable模式</h2><h3 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h3><p>Immutable是“永恒的”“不会改变”的意思。在Immutable Patttern中，有着能够保证实例状态绝不会改变的类（immutable 类）。因为访问这个实例时，可以省去使用共享互斥机制所会浪费的时间，提高系统性能。java.lang.String就是一个Immutable的类。</p><p><strong>模式讲解</strong></p><ul><li>Immutable(不变的)参与者<br>Immutable参与者是一个字段值无法更改的类，也没有任何用来更改字段值的方法。当Immutable参与者的实例建立后，状态就完全不再变化。</li></ul><img src="/posts/4b405cfc/38.jpg" srcset="/img/loading.gif" lazyload style="zoom:80%"><blockquote><p>即便字段是final字段，且不存在setter方法，也有可能不是不可变的。因为即使字段的值不会发生变化，字段引用的实例也有可能会发生变化。</p></blockquote><p>Java标准类库中用到immutable模式</p><ul><li>java.lang.String</li><li>java.math.BigInteger 和 java.math.BigDecimal。（BigInterger表示所有精度的整数，BigDecimal表示所有精度的数）</li><li>java.util.regex.Pattern 正则表达式</li><li>java.lang.Integer等基本类型的包装类</li><li>java.awt.Color</li></ul><blockquote><p>java.lang.Void类不同于其他的包装类，它无法创建实例。该类用于保存表示基本类型void的Class类的实例，用在反射和序列化中。</p></blockquote><h2 id="Guarded-Suspension模式"><a href="#Guarded-Suspension模式" class="headerlink" title="Guarded Suspension模式"></a>Guarded Suspension模式</h2><h3 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h3><p>guarded是“被保护着的”、“被防卫着的”意思，suspension则是“暂停”的意思。当现在并不适合马上执行某个操作时，就要求想要执行该操作的线程等待。</p><h3 id="模式讲解"><a href="#模式讲解" class="headerlink" title="模式讲解"></a>模式讲解</h3><p>角色：<br>Guarded Suspension Pattern 的角色如下：</p><ul><li>GuardedObject (被防卫的对象)参与者<br>GuardedObject 参与者是一个拥有被防卫的方法（guardedMethod）的类。当线程执行guardedMethod时，只要满足警戒条件，就能继续执行，否则线程会进入wait set区等待。警戒条件是否成立随着GuardedObject的状态而变化。<br>GuardedObject 参与者除了guardedMethod外，可能还有用来更改实例状态的的方法stateChangingMethod。</li></ul><p>在Java语言中，是使用while语句和wait方法来实现guardedMethod的；使用notify&#x2F;notifyAll方法实现stateChangingMethod。如案例中的RequestQueue 类。</p><img src="/posts/4b405cfc/39.jpg" srcset="/img/loading.gif" lazyload style="zoom:67%"><h2 id="Balking模式"><a href="#Balking模式" class="headerlink" title="Balking模式"></a>Balking模式</h2><h3 id="定义-3"><a href="#定义-3" class="headerlink" title="定义"></a>定义</h3><ol><li>我正坐在餐馆中，合计着吃点什么。想好之后，我举起手示意服务员点菜。于是，看到我举手的服务员就向我走来点菜。这时，另一位服务员也看到我举手示意了，但他看到已经有一位服务员走向了我，所以就没有再过来。</li><li>如果现在不适合执行这个操作，或者没必要执行这个操作，就停止处理，直接返回——这就是Balking模式。</li><li>所谓Balk，就是 “停止并返回” 的意思。</li><li>Balking 模式与Guarded Suspension模式一样，也存在守护条件。在Balking模式中，如果守护条件不成立，则立即中断处理。这与Guarded Suspension模式有所不同，因为Guarded Suspension模式是一直等待至可以运行。</li></ol><h3 id="模式详解"><a href="#模式详解" class="headerlink" title="模式详解"></a>模式详解</h3><p>角色：</p><p>GuardedObject（被防护的对象）</p><ol><li>GuardedObject角色是一个拥有被防护的方法（guardedMethod）的类。当线程执行guardedMethod方法时，若守护条件成立，则执行实际的处理。而当守护条件不成立时，则不执行实际的处理，直接返回。守护条件的成立与否，会随着GuardedObject角色的状态变化而发生变化。</li><li>除了guardedMethod之外，GuardedObject角色还有可能有其他来改变状态的方法（stateChangingMethod）。</li></ol><p>类图：</p><img src="/posts/4b405cfc/46.png" srcset="/img/loading.gif" lazyload style="zoom:67%"> <img src="/posts/4b405cfc/47.jpg" srcset="/img/loading.gif" lazyload><blockquote><p>状态仅变化一次的变量，我们通常称为闭锁（latch，门闩）。这个门闩一旦插上，就再也打不开了</p></blockquote><p>在守护条件成立之前等待一段时间，如果到时条件还未成立，则直接balk。我们将这种处理称为guarded timed 或timeout。</p><p>在java中，我们使用if来检查守护条件。balk处理的执行则是使用return从方法中退出，或者使用throw抛出异常。守护条件的检查处理则是使用synchronized放在临界区中。</p><h3 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.FileWriter;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.Writer;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String filename;<br>    <span class="hljs-keyword">private</span> String content;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> changed;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Data</span><span class="hljs-params">(String filename, String content)</span> &#123;<br>        <span class="hljs-built_in">this</span>.filename = filename;<br>        <span class="hljs-built_in">this</span>.content = content;<br>        <span class="hljs-built_in">this</span>.changed = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//修改了数据内容</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">change</span><span class="hljs-params">(String newContent)</span> &#123;<br>        content = newContent;<br>        changed = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//若数据修改过，则保存到文件中</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">if</span> (!changed) &#123;<br>            <span class="hljs-comment">//如果没有修改，就不保存了</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        doSave();<br>        changed = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//将数据内容保存到文件中</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSave</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; calls doSave, content =&quot;</span> + content);<br>        <span class="hljs-type">Writer</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(filename);<br>        writer.write(content);<br>        writer.close();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChangerThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Data data;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChangerThread</span><span class="hljs-params">(String name, Data data)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name);<br>        <span class="hljs-built_in">this</span>.data = data;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-literal">true</span>; i++) &#123;<br>                data.change(<span class="hljs-string">&quot;NO.&quot;</span> + i);<span class="hljs-comment">//修改数据</span><br>                Thread.sleep(random.nextInt(<span class="hljs-number">1000</span>));<span class="hljs-comment">//执行其他操作</span><br>                data.save();<span class="hljs-comment">//显示的保存,用户自己点击保存</span><br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SaverThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Data data;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SaverThread</span><span class="hljs-params">(String name, Data data)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name);<br>        <span class="hljs-built_in">this</span>.data = data;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                data.save();<span class="hljs-comment">//要求保存数据</span><br>                Thread.sleep(<span class="hljs-number">1000</span>);<span class="hljs-comment">//休眠约一秒</span><br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Data</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Data</span>(<span class="hljs-string">&quot;data.txt&quot;</span>, <span class="hljs-string">&quot;(empty)&quot;</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChangerThread</span>(<span class="hljs-string">&quot;ChangeThread&quot;</span>, data).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SaverThread</span>(<span class="hljs-string">&quot;SaverThread&quot;</span>, data).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="java-util-cocurrent中的超时"><a href="#java-util-cocurrent中的超时" class="headerlink" title="java.util.cocurrent中的超时"></a>java.util.cocurrent中的超时</h3><h4 id="通过异常通知超时"><a href="#通过异常通知超时" class="headerlink" title="通过异常通知超时"></a>通过异常通知超时</h4><p>当发生超时抛出异常时，返回值并不适合用于表示超时，需要使用java.util.concurrent.TimeoutException异常。</p><ul><li><strong>java.util.concurrent.Future接口的get方法</strong></li><li><strong>java.util.concurrent.Exchanger类的exchange方法</strong></li><li><strong>java.util.concurrent.Cyclicarrier类的await方法</strong></li><li><strong>java.util.concurrent.CountDownLatch类的await方法</strong></li></ul><h4 id="通过返回值通知超时"><a href="#通过返回值通知超时" class="headerlink" title="通过返回值通知超时"></a>通过返回值通知超时</h4><p>当执行多次try时，则不使用异常，而是使用返回值来表示超时。</p><ul><li><p><strong>java.util.concurrent.BlockingQueue接口</strong></p><p>当offer方法的返回值为false，或poll方法的返回值为null时，表示发生了超时。</p></li><li><p><strong>java.util.concurrent.Semaphore类</strong></p><p>当tryAcquire方法的返回值为false时，表示发生了超时。</p></li><li><p><strong>java.util.concurrent.locks.lock接口</strong></p><p>当tryLock方法的返回值为false时，表示发生了超时。</p></li></ul><h2 id="Producer-Consumer模式"><a href="#Producer-Consumer模式" class="headerlink" title="Producer-Consumer模式"></a>Producer-Consumer模式</h2><h3 id="定义-4"><a href="#定义-4" class="headerlink" title="定义"></a>定义</h3><p>Producer-Consumer Pattern就是生产者-消费者模式。<br>生产者和消费者在为不同的处理线程，生产者必须将数据安全地交给消费者，消费者进行消费时，如果生产者还没有建立数据，则消费者需要等待。<br>一般来说，可能存在多个生产者和消费者，不过也有可能生产者和消费者都只有一个，当双方都只有一个时，我们也称之为Pipe模式。</p><h3 id="模式讲解-1"><a href="#模式讲解-1" class="headerlink" title="模式讲解"></a>模式讲解</h3><p>Producer-Consumer模式的角色如下：</p><ul><li>Data(数据)参与者<br>Data代表了实际生产或消费的数据。</li><li>Producer(生产者)参与者<br>Producer会创建Data，然后传递给Channel参与者。</li><li>Consumer(消费者)参与者<br>Consumer从Channel参与者获取Data数据，进行处理。</li><li>Channel(通道)参与者<br>Channel从Producer参与者处接受Data参与者，并保管起来，并应Consumer参与者的要求，将Data参与者传送出去。为确保安全性，Producer参与者与Consumer参与者要对访问共享互斥。</li></ul><img src="/posts/4b405cfc/48.jpg" srcset="/img/loading.gif" lazyload><blockquote><p>在Swing（JFC）框架中，事件处理部分使用的就是这种方法（多个Producer角色对应一个Comsumer角色）。执行Swing事件处理的线程称为事件分发线程。这个线程相当于从Channel角色的事件队列取出事件并进行处理的Comsumer角色。事件分发线程只有一个。</p></blockquote><h3 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">ArrayBlockingQueue</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 使用 queue</span><br><span class="hljs-comment"> */</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlockingQueueTable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ArrayBlockingQueue</span>&lt;<span class="hljs-title class_">String</span>&gt; &#123;<br><br>    public <span class="hljs-title class_">BlockingQueueTable</span>(int size) &#123;<br>        <span class="hljs-variable language_">super</span>(size);<br>    &#125;<br><br>    public <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span>(final <span class="hljs-title class_">String</span> cakeName) throws <span class="hljs-title class_">InterruptedException</span> &#123;<br>        <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">put</span>(cakeName);<br>    &#125;<br><br>    public <span class="hljs-title class_">String</span> <span class="hljs-title function_">take</span>() throws <span class="hljs-title class_">InterruptedException</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">take</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> BlockingQueueTable 可以被这个替换</span><br><span class="hljs-comment"> */</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">Table</span> &#123;<br><br>    private <span class="hljs-title class_">String</span>[] cakeArray;<br><br>    private int head;<br><br>    private int tail;<br><br>    private int count;<br><br>    private final int size;<br><br>    public <span class="hljs-title class_">Table</span>(int size) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = size;<br>        cakeArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[size];<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">head</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    public synchronized <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span>(final <span class="hljs-title class_">String</span> cakeName) throws <span class="hljs-title class_">InterruptedException</span> &#123;<br>        <span class="hljs-keyword">while</span> (count &gt;= size) &#123;<br>            <span class="hljs-title function_">wait</span>();<br>        &#125;<br><br>        cakeArray[tail] = cakeName;<br>        count++;<br>        tail = (tail + <span class="hljs-number">1</span>) % size;<br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">getName</span>() + <span class="hljs-string">&quot; put cake &quot;</span> + cakeName);<br><br>        <span class="hljs-title function_">notifyAll</span>();<br>    &#125;<br><br>    public synchronized <span class="hljs-title class_">String</span> <span class="hljs-title function_">take</span>() throws <span class="hljs-title class_">InterruptedException</span> &#123;<br>        <span class="hljs-keyword">while</span> (count &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-title function_">wait</span>();<br>        &#125;<br><br>        <span class="hljs-title class_">String</span> result = cakeArray[head];<br>        head = (head + <span class="hljs-number">1</span>) % size;<br>        count--;<br><br>        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">getName</span>() + <span class="hljs-string">&quot; take cake &quot;</span> + result);<br>        <span class="hljs-title function_">notifyAll</span>();<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Random</span>;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerCakeThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Thread</span> &#123;<br><br>    private <span class="hljs-title class_">String</span> name;<br><br>    private final <span class="hljs-title class_">Table</span> table;<br><br>    public <span class="hljs-title class_">ConsumerCakeThread</span>(<span class="hljs-title class_">String</span> name, <span class="hljs-title class_">Table</span> table) &#123;<br>        <span class="hljs-variable language_">super</span>(name);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span> = table;<br>    &#125;<br><br>    @<span class="hljs-title class_">Override</span><br>    public <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Random</span> random = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>(1000L);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(random.<span class="hljs-title function_">nextInt</span>(<span class="hljs-number">1000</span>));<br>                table.<span class="hljs-title function_">take</span>();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) &#123;<br>            e.<span class="hljs-title function_">printStackTrace</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Random</span>;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerCakeThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Thread</span> &#123;<br><br>    private final <span class="hljs-title class_">Table</span> table;<br><br>    private <span class="hljs-keyword">static</span> int id = <span class="hljs-number">0</span>;<br><br>    public <span class="hljs-title class_">ProducerCakeThread</span>(<span class="hljs-title class_">String</span> name, <span class="hljs-title class_">Table</span> table) &#123;<br>        <span class="hljs-variable language_">super</span>(name);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span> = table;<br>    &#125;<br><br>    @<span class="hljs-title class_">Override</span><br>    public <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Random</span> random = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>(1000L);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-title class_">String</span> cakeName = <span class="hljs-title function_">getName</span>() + <span class="hljs-string">&quot;-&quot;</span> + <span class="hljs-title function_">genId</span>();<br>                <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(random.<span class="hljs-title function_">nextInt</span>(<span class="hljs-number">1000</span>));<br>                table.<span class="hljs-title function_">put</span>(cakeName);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) &#123;<br>            e.<span class="hljs-title function_">printStackTrace</span>();<br>        &#125;<br>    &#125;<br><br>    private <span class="hljs-keyword">static</span> synchronized int <span class="hljs-title function_">genId</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> id++;<br>    &#125;<br>&#125;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br><br>    public <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;<br>        <span class="hljs-title class_">Table</span> table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Table</span>(<span class="hljs-number">3</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConsumerCakeThread</span>(<span class="hljs-string">&quot;ConsumerCake&quot;</span>, table).<span class="hljs-title function_">start</span>();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProducerCakeThread</span>(<span class="hljs-string">&quot;ProducerCake&quot;</span>, table).<span class="hljs-title function_">start</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Read-Write-Lock模式"><a href="#Read-Write-Lock模式" class="headerlink" title="Read-Write Lock模式"></a>Read-Write Lock模式</h2><h3 id="定义-5"><a href="#定义-5" class="headerlink" title="定义"></a>定义</h3><p>Read-Write Lock Pattern将读取与写入分开处理，在读取数据之前必须获取用来读取的锁定，而写入的时候必须获取用来写入的锁定。因为读取时实例的状态不会改变，所以多个线程可以同时读取；但是，写入会改变实例的状态，所以当有一个线程写入的时候，其它线程既不能读取与不能写入。</p><h3 id="模式详解-1"><a href="#模式详解-1" class="headerlink" title="模式详解"></a>模式详解</h3><p>Read-Write Lock模式的角色如下：</p><ul><li><strong>Reader(读取者)参与者</strong><br>Reader参与者会对SharedResource进行读。</li><li><strong>Writer(写入者)参与者</strong><br>Writer参与者会对SharedResource进行写。</li><li><strong>SharedResource(共享资源)参与者</strong><br>SharedResource代表Reader和Writer所共享的资源对象，SharedResource提供不改变内部状态的read操作，以及会改变内部状态的write操作。</li><li><strong>ReadWriteLock(读写锁)参与者</strong><br>ReadWriteLock提供了对SharedResource参与者进行read操作和write操作时需要的锁定。</li></ul><img src="/posts/4b405cfc/49.jpg" srcset="/img/loading.gif" lazyload> <img src="/posts/4b405cfc/50.jpg" srcset="/img/loading.gif" lazyload><p>总结<br>SharedResource角色提供了read和write两个操作。read不会改变其状态，而write会，当Reader角色在read时，Writer角色必须等，而当Writer角色正在write时，Reader角色和其他Writer角色也必须等待。于是引入了ReadWriteLock角色，该角色提供分别用于read和write的锁，来执行上述的互斥处理，这样，确保了SharedResource角色的安全性，当read操作特别繁重时，程序性能能大大提高，在实现时，必须充分考虑执行互斥处理时采用的Guarded Suspension模式的守护条件。使用finally防止忘记释放锁，这就是Read Write Lock模式。</p><h3 id="示例代码-3"><a href="#示例代码-3" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span>[] buffer;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantReadWriteLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">//这个其实是java.util.concurrent.locks写好的读写锁类,可以直接调用 不用自己写啦.</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> lock.readLock(); <span class="hljs-comment">// 读锁</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> lock.writeLock(); <span class="hljs-comment">// 写锁</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReadWriteLock</span> <span class="hljs-variable">readWriteLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReadWriteLock</span>();<span class="hljs-comment">//我们自己实现的读写锁类</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Data</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span> &#123;<br>        <span class="hljs-built_in">this</span>.buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[size];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; buffer.length; i++) &#123;<br>            buffer[i] = <span class="hljs-string">&#x27;*&#x27;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">char</span>[] read() <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        readWriteLock.readLock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> doRead();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            readWriteLock.unReadLock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">char</span> c)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        readWriteLock.writeLock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            doWrite(c);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            readWriteLock.unWriteLock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">char</span>[] doRead() &#123;<br>        <span class="hljs-type">char</span>[] newbuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[buffer.length];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; newbuf.length; i++) &#123;<br>            newbuf[i] = buffer[i];<br>        &#125;<br>        slowly();<br>        <span class="hljs-keyword">return</span> newbuf;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">slowly</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">50</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-comment">// TODO Auto-generated catch block</span><br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doWrite</span><span class="hljs-params">(<span class="hljs-type">char</span> c)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; buffer.length; i++) &#123;<br>            buffer[i] = c;<br>            slowly();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReaderThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Data data;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReaderThread</span><span class="hljs-params">(Data data)</span> &#123;<br>        <span class="hljs-built_in">this</span>.data = data;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-type">char</span>[] read = data.read();<br>                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; reads &quot;</span> + String.valueOf(read));<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> handle exception</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WriterThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Data data;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String filler;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WriterThread</span><span class="hljs-params">(Data data, String filler)</span> &#123;<br>        <span class="hljs-built_in">this</span>.data = data;<br>        <span class="hljs-built_in">this</span>.filler = filler;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> nextchar();<br>                data.write(c);<br>                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; write &quot;</span> + c);<br>                Thread.sleep(random.nextInt(<span class="hljs-number">3000</span>));<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> handle exception</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">char</span> <span class="hljs-title function_">nextchar</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> filler.charAt(index);<br>        index++;<br>        <span class="hljs-keyword">if</span> (index &gt;= filler.length()) &#123;<br>            index = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> c;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReadWriteLock</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">readingReaders</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 正在读取的线程数量</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">writingWriters</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 正在写入的线程数量</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">while</span> (writingWriters &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// 如果有线程在执行写入,等待.</span><br>            wait();<br>        &#125;<br>        readingReaders++;  <span class="hljs-comment">// 实际在读取的线程+1</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unReadLock</span><span class="hljs-params">()</span> &#123;<br>        readingReaders--;  <span class="hljs-comment">// 实际读取线程-1</span><br>        notifyAll();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">while</span> (writingWriters &gt; <span class="hljs-number">0</span> || readingReaders &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// 如果有线程正在写入,或者在读取 等待</span><br>            wait();<br>        &#125;<br>        writingWriters++; <span class="hljs-comment">// 正在写入的线程+1</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unWriteLock</span><span class="hljs-params">()</span> &#123;<br>        writingWriters--; <span class="hljs-comment">// 正在写入的线程-1</span><br>        notifyAll();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Data</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Data</span>(<span class="hljs-number">10</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReaderThread</span>(data).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReaderThread</span>(data).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReaderThread</span>(data).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReaderThread</span>(data).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReaderThread</span>(data).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReaderThread</span>(data).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">WriterThread</span>(data, <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">WriterThread</span>(data, <span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ReentrantReadWriteLock特点"><a href="#ReentrantReadWriteLock特点" class="headerlink" title="ReentrantReadWriteLock特点"></a><strong>ReentrantReadWriteLock特点</strong></h3><ul><li><p>公平性</p><p>当创建ReentrantReadWriteLock类的实例时，我们可以选择锁的获取顺序是否要设为公平的。如果创建的实例是公平的，那么等待时间久的线程可以优先获取锁。</p></li><li><p>可重入性</p><p>ReentrantReadWriteLock类的锁是可重入的。也就是说，Reader角色的线程可以获取“用于写入的锁”，Writer角色的线程也可以获取“用于读取的锁”。</p></li><li><p>锁降级</p><p>ReentrantReadwriteLock类可以按如下顺序将“用于写入的锁”降级为“用于读取的锁”。</p><ul><li><p>获取用于写入的锁</p></li><li><p>获取用于读取的锁</p></li><li><p>释放用于写入的锁</p></li></ul><p>但是，“用于读取的锁”不可以升级为“用户写入的锁”。</p></li><li><p>便携方法</p><p>ReentrantReadWriteLock类提供了获取等待中的线程的个数的方法getQueueLength，以及检查是否获取了用于写入的锁的方法isWriteLocked等便携方法。</p></li></ul><h2 id="Thread-per-Message模式"><a href="#Thread-per-Message模式" class="headerlink" title="Thread-per-Message模式"></a>Thread-per-Message模式</h2><h3 id="定义-6"><a href="#定义-6" class="headerlink" title="定义"></a>定义</h3><p>Thread-Per-Message模式是说为每个请求都分配一个线程，由这个线程来执行处理，使得消息能够并发（但是注意：线程的创建是有限的，可以使用线程池来处理，超过数量则加入等待队列），这里包含两个角色，请求的提交线程和请求的执行线程。</p><h3 id="模式详解-2"><a href="#模式详解-2" class="headerlink" title="模式详解"></a>模式详解</h3><ul><li>Client（委托人）<br>Client角色会向Host角色发出请求（request），但是并不知道Host角色是如何实现该请求的。</li><li>Host<br>Host角色收到Client角色的请求（request）之后，会新创建并启动一个线程。新创建的线程将使用Helper角色来 “处理”（handle）请求。</li><li>Helper（助手）<br>Helper角色为Host角色提供请求处理的功能。Host角色创建的新线程会利用Helper角色。</li></ul><img src="/posts/4b405cfc/53.png" srcset="/img/loading.gif" lazyload> <img src="/posts/4b405cfc/54.jpg" srcset="/img/loading.gif" lazyload style="zoom:80%"><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ol><li><strong>提高响应性，缩短延迟时间</strong><br>Thread-Per-Message模式能够提高与Client角色对应的Host角色的响应性，降低延迟时间。尤其是当handle操作非常耗时，或者handle操作需要等待输入&#x2F;输出时，效果非常明显。<br>在Thread-Per-Message模式下，Host角色会启动新的线程。由于启动线程也会花费时间，所以想要提高响应性时，是否使用Thread-Per-Message模式取决于 “handle操作花费的时间” 和 “线程启动花费的时间” 之间的均衡。</li><li><strong>适用于操作顺序没有要求时</strong><br>在Thread-Per-Message模式中，handle方法并不一定是按request方法的调用顺序来执行的。因此，当操作要按某种顺序执行时，Thread-Per-Message模式并不适用。</li><li><strong>适用于不需要返回值时</strong><br>在Thread-Per-Message模式中，request方法并不会等待handle方法执行结束。所以request得不到handle的运行结果。因此，Thread-Per-Message模式适用于不需要获取返回值的情况。例如通知某个事件时。</li><li><strong>应用于服务器</strong><br>为了使服务器可以处理多个请求，我们可以使用Thread-Per-Message模式。服务器本身的线程接收客户端的请求，而这些请求的实际处理则交由其他线程来执行，服务器本身的线程则返回，去等待客户端的其他请求。</li></ol><h3 id="Factory-Method模式"><a href="#Factory-Method模式" class="headerlink" title="Factory Method模式"></a><strong>Factory Method模式</strong></h3><p>使用new创建Thread实例时，代码依赖于java.lang.Thread类。这时，我们无法控制创建线程的部分，可复用性较低。假如我们用字段threadFactory来保存ThreadFactory对象，用threadFactory.newThread(…)来替代new Thread(…)。这样一来，只要替换赋给threadFactory的ThreadFactory对象，我们便可以控制线程创建了。这就是Factory Method模式。</p><p><strong>示例代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Helper</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(<span class="hljs-type">int</span> count, <span class="hljs-type">char</span> c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;handle begin&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            slowly();<br>            System.out.print(c);<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;handle end&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">slowly</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">100</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-comment">// TODO Auto-generated catch block</span><br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Host</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Helper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadFactory threadFactory;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Host</span><span class="hljs-params">()</span> &#123;<br>        threadFactory = <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Host</span><span class="hljs-params">(ThreadFactory threadFactory)</span> &#123;<br>        <span class="hljs-built_in">this</span>.threadFactory = threadFactory;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">request</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> count, <span class="hljs-keyword">final</span> <span class="hljs-type">char</span> c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;request begin [&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;] begin&quot;</span>);<br>        threadFactory.newThread(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                helper.handle(count, c);<br>            &#125;<br>        &#125;).start();<br>        System.out.println(<span class="hljs-string">&quot;request begin [&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;] end&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main begin&quot;</span>);<br><br>        <span class="hljs-type">ThreadFactory</span> <span class="hljs-variable">threadFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactory</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Thread <span class="hljs-title function_">newThread</span><span class="hljs-params">(Runnable r)</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r);<br>            &#125;<br>        &#125;;<br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Host</span>(threadFactory);<br>        host.request(<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;A&#x27;</span>);<br>        host.request(<span class="hljs-number">20</span>, <span class="hljs-string">&#x27;B&#x27;</span>);<br>        host.request(<span class="hljs-number">30</span>, <span class="hljs-string">&#x27;C&#x27;</span>);<br>        System.out.println(<span class="hljs-string">&quot;main End&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="java-util-concurrent-Executor接口"><a href="#java-util-concurrent-Executor接口" class="headerlink" title="java.util.concurrent.Executor接口"></a><strong>java.util.concurrent.Executor接口</strong></h3><p>Executor接口将某些“处理的执行”抽象化了，参数传入的Runnable对象表示“执行的处理”的内容。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Helper</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(<span class="hljs-type">int</span> count, <span class="hljs-type">char</span> c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;handle begin&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            slowly();<br>            System.out.print(c);<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;handle end&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">slowly</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">100</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-comment">// TODO Auto-generated catch block</span><br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Host</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Helper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Executor executor;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Host</span><span class="hljs-params">(Executor executor)</span> &#123;<br>        <span class="hljs-built_in">this</span>.executor = executor;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">request</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> count, <span class="hljs-keyword">final</span> <span class="hljs-type">char</span> c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;request begin [&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;] begin&quot;</span>);<br>        executor.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                helper.handle(count, c);<br>            &#125;<br>        &#125;);<br>        System.out.println(<span class="hljs-string">&quot;request begin [&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;] end&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main begin&quot;</span>);<br>        <span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Executor</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable r)</span> &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r).start();<br>            &#125;<br>        &#125;;<br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Host</span>(executor);<br>        host.request(<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;A&#x27;</span>);<br>        host.request(<span class="hljs-number">20</span>, <span class="hljs-string">&#x27;B&#x27;</span>);<br>        host.request(<span class="hljs-number">30</span>, <span class="hljs-string">&#x27;C&#x27;</span>);<br>        System.out.println(<span class="hljs-string">&quot;main End&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="java-util-concurrent-ExecutorService接口"><a href="#java-util-concurrent-ExecutorService接口" class="headerlink" title="java.util.concurrent.ExecutorService接口"></a><strong>java.util.concurrent.ExecutorService接口</strong></h4><p>ExecutorService接口对可以反复execute的服务进行了抽象化。线程一直在后台运行着，每当调用execute方式时，在ExecutorService接口后面，线程是一直在运行着，所以ExecutorService接口<strong>提供了shutdown方法</strong>来结束服务。</p><p><strong>示例代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main begin&quot;</span>);<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();<br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Host</span>(executorService);<br>        <span class="hljs-keyword">try</span> &#123;<br>            host.request(<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;A&#x27;</span>);<br>            host.request(<span class="hljs-number">20</span>, <span class="hljs-string">&#x27;B&#x27;</span>);<br>            host.request(<span class="hljs-number">30</span>, <span class="hljs-string">&#x27;C&#x27;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            executorService.shutdown();<br>            System.out.println(<span class="hljs-string">&quot;main End&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>java.util.concurrent.ScheduledExecutorService类</strong></p><p>java.util.concurrent.ScheduledExecutorService接口是ExecutorService的子接口，用于推迟操作的执行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Helper</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(<span class="hljs-type">int</span> count, <span class="hljs-type">char</span> c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;handle begin&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            slowly();<br>            System.out.print(c);<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;handle end&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">slowly</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">100</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-comment">// TODO Auto-generated catch block</span><br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Host</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Helper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Helper</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ScheduledExecutorService scheduledExecutorService;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Host</span><span class="hljs-params">(ScheduledExecutorService scheduledExecutorService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.scheduledExecutorService = scheduledExecutorService;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">request</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> count, <span class="hljs-keyword">final</span> <span class="hljs-type">char</span> c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;request begin [&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;] begin&quot;</span>);<br>        scheduledExecutorService.schedule(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                helper.handle(count, c);<br>            &#125;<br>        &#125;, <span class="hljs-number">3L</span>, TimeUnit.SECONDS);<br>        System.out.println(<span class="hljs-string">&quot;request begin [&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;] end&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main begin&quot;</span>);<br>        <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduledExecutorService</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">5</span>);<br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Host</span>(scheduledExecutorService);<br>        <span class="hljs-keyword">try</span> &#123;<br>            host.request(<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;A&#x27;</span>);<br>            host.request(<span class="hljs-number">20</span>, <span class="hljs-string">&#x27;B&#x27;</span>);<br>            host.request(<span class="hljs-number">30</span>, <span class="hljs-string">&#x27;C&#x27;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            scheduledExecutorService.shutdown();<br>            System.out.println(<span class="hljs-string">&quot;main End&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><img src="/posts/4b405cfc/55.png" srcset="/img/loading.gif" lazyload style="zoom:50%"><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Client 角色调用Host角色的request方法发来的请求，该请求的实际处理则交给Helper的handle去执行，然而，如果Client直接从request中调用handle方法，那么直到实际操作结束之前，都无法从handle方法返回（request返回），这样一来request的响应性能就下降了，因此，Host角色会启动用于处理来自Client角色请求的新线程，并让该线程来调用handle，这样一来发出请求的线程便可以立即从handle中返回。这就是Thread-Per-Message模式。</p><h2 id="Worker-Thread模式"><a href="#Worker-Thread模式" class="headerlink" title="Worker Thread模式"></a>Worker Thread模式</h2><h3 id="定义-7"><a href="#定义-7" class="headerlink" title="定义"></a>定义</h3><p>Worker的意思是工作的人、劳动者。在Worker Thread模式中，工人线程会逐个取回工作并进行处理。当所有工作全部完成后，工人线程会等待新的工作到来。</p><p>Worker Thread模式也被称为Background Thread（背景线程）模式。另外，如果从“保存多个工人线程的场所”这一点来看，我们也可以称这种模式为Thread Pool（线程池）模式。</p><h3 id="模式详解-3"><a href="#模式详解-3" class="headerlink" title="模式详解"></a>模式详解</h3><img src="/posts/4b405cfc/57.png" srcset="/img/loading.gif" lazyload style="zoom:50%"> <img src="/posts/4b405cfc/56.png" srcset="/img/loading.gif" lazyload style="zoom:50%"> <img src="/posts/4b405cfc/58.png" srcset="/img/loading.gif" lazyload style="zoom:50%"><p><strong>角色</strong></p><ul><li><p>Client（委托者）</p><p>Client角色创建表示工作请求的Request角色并将其传递给Channel角色。在示例程序中，由ClientThread类扮演此角色。</p></li><li><p>Channel（通信线路）</p><p>Channel角色接受来自于Client角色的Request角色，并将其传递给Worker角色。在示例程序中，由Channel类扮演此角色。</p></li><li><p>Worker（工人）</p><p>Worker角色从Channel角色中获取Request角色，并进行工作。当一项工作完成后，它会继续去获取另外的Channel角色。在示例程序中，由WorkerThread类扮演此角色。</p></li><li><p>Request（请求）</p><p>Request角色是表示工作的角色。Request角色中保存了进行工作所必需的信息。在示例程序中，由Request角色扮演此角色。</p></li></ul><img src="/posts/4b405cfc/59.png" srcset="/img/loading.gif" lazyload style="zoom:50%"><h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><ul><li><p><strong>提高响应速度</strong></p><p>调用和执行分离。执行完调用处理的一方可以先继续执行其他处理，这样就可以提高响应速度。</p></li><li><p><strong>控制执行顺序（调度）</strong></p><p>如果调用和执行不可分离，那么在调用后就必须开始执行。</p><p>但是如果将调用和执行分离，执行就可以不再受调用调用顺序的制约。我们可以通过<strong>设置Request角色的优先级，并控制Channel角色将Request角色传递给Worker角色的顺序来实现上述处理。这种处理称为请求调度（scheduling）</strong>。</p></li><li><p><strong>可以取消和反复执行</strong></p><p>将调用和执行分离后，还可以实现“即使调用了也可以被取消执行”这种功能。</p><p>由于调用的是Request对象，所以既可以将Request角色保存，又可以反复的执行。</p></li><li><p><strong>通往分布式之路</strong></p><p>将调用和执行分离后，可以将负责调用的计算机与负责执行的计算机分离开来，然后通过网络将扮演Request角色的对象从一台计算机传递至另外一台计算机。</p></li></ul><h2 id="Future模式"><a href="#Future模式" class="headerlink" title="Future模式"></a>Future模式</h2><h3 id="定义-8"><a href="#定义-8" class="headerlink" title="定义"></a>定义</h3><p>Future模式是多线程开发中非常常见的一种设计模式。它的核心思想是异步调用。当我们需要调用一个函数方法时。如果这个函数执行很慢,那么我们就要进行等待。但有时候,我们可能并不急着要结果。因此,我们可以让被调用者立即返回,让他在后台慢慢处理这个请求。对于调用者来说,则可以先处理一些其他任务,在真正需要数据的场合再去尝试获取需要的数据。</p><blockquote><p>由于Future角色是”只能被赋值一次的变量“，所以可以把它看作一种闭锁（latch）。</p></blockquote><h3 id="模式详解-4"><a href="#模式详解-4" class="headerlink" title="模式详解"></a>模式详解</h3><table><thead><tr><th>名字</th><th>说明</th></tr></thead><tbody><tr><td>Main</td><td>向Host发出请求并获取数据的类</td></tr><tr><td>Host</td><td>向请求返回FutureData的实例的类</td></tr><tr><td>Data</td><td>表示访问数据的方法的接口。由FutureData和RealData实现该接口</td></tr><tr><td>FutureData</td><td>表示RealData的“提货单”的类。其他线程会创建RealData的实例。</td></tr><tr><td>RealData</td><td>表示实际数据的类。构造函数的处理会花费很长时间</td></tr></tbody></table><p><strong>类图</strong></p><img src="/posts/4b405cfc/60.png" srcset="/img/loading.gif" lazyload style="zoom:50%"><p><strong>时序图</strong></p><img src="/posts/4b405cfc/61.png" srcset="/img/loading.gif" lazyload style="zoom:50%"><p><strong>角色</strong></p><ul><li><p>Client（请求者）</p><p>Client角色向Host角色发出，并会立即接收到请求的处理结果——VirtualData角色。</p></li><li><p>Host</p><p>Host角色会创建新的线程，并开始在新线程中创建RealData角色。同时，它会将Future角色（当做VirtualData角色）返回给Client角色。</p></li><li><p>VirtualData</p><p>VirtualData角色是让Future角色和RealData角色具有一致性的角色。</p></li><li><p>RealData</p><p>RealData角色是表示真实数据的角色。</p></li><li><p>Future</p><p>Future角色是RealData角色的”提货单“，由Host角色传递给Client角色。</p></li></ul><h3 id="示例代码-4"><a href="#示例代码-4" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Data</span> &#123;<br>    String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FutureData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Data</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">RealData</span> <span class="hljs-variable">realData</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">ready</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRealData</span><span class="hljs-params">(RealData realData)</span> &#123;<br>        <span class="hljs-keyword">if</span> (ready) &#123;<br>            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// balk</span><br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;setting content = &quot;</span>+ realData.getContent());<br>        <span class="hljs-built_in">this</span>.realData = realData;<br>        <span class="hljs-built_in">this</span>.ready = <span class="hljs-literal">true</span>;<br>        notifyAll();<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (!ready) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                wait();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> realData.getContent();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RealData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Data</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String content;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RealData</span><span class="hljs-params">(<span class="hljs-type">int</span> count, <span class="hljs-type">char</span> c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;    making RealData(&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;) BEGIN&quot;</span>);<br>        <span class="hljs-type">char</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[count];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            buffer[i] = c;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">100</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;    making RealData(&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;) END&quot;</span>);<br>        <span class="hljs-built_in">this</span>.content = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> content;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Host</span> &#123;<br>    <span class="hljs-keyword">public</span> Data <span class="hljs-title function_">request</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> count, <span class="hljs-keyword">final</span> <span class="hljs-type">char</span> c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;    request(&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;) BEGIN&quot;</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">FutureData</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureData</span>();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-type">RealData</span> <span class="hljs-variable">realData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealData</span>(count, c);<br>                future.setRealData(realData);<br>            &#125;<br>        &#125;).start();<br><br>        System.out.println(<span class="hljs-string">&quot;    request(&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;) END&quot;</span>);<br>        <span class="hljs-keyword">return</span> future;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main BEGIN&quot;</span>);<br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Host</span>();<br>        <span class="hljs-type">Data</span> <span class="hljs-variable">data1</span> <span class="hljs-operator">=</span> host.request(<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;A&#x27;</span>);<br>        <span class="hljs-type">Data</span> <span class="hljs-variable">data2</span> <span class="hljs-operator">=</span> host.request(<span class="hljs-number">20</span>, <span class="hljs-string">&#x27;B&#x27;</span>);<br>        <span class="hljs-type">Data</span> <span class="hljs-variable">data3</span> <span class="hljs-operator">=</span> host.request(<span class="hljs-number">30</span>, <span class="hljs-string">&#x27;C&#x27;</span>);<br><br>        System.out.println(<span class="hljs-string">&quot;main otherJob BEGIN&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">5000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;main otherJob END&quot;</span>);<br><br>        System.out.println(<span class="hljs-string">&quot;data1 = &quot;</span> + data1.getContent());<br>        System.out.println(<span class="hljs-string">&quot;data2 = &quot;</span> + data2.getContent());<br>        System.out.println(<span class="hljs-string">&quot;data3 = &quot;</span> + data3.getContent());<br>        System.out.println(<span class="hljs-string">&quot;main END&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="java-util-concurrent-示例程序"><a href="#java-util-concurrent-示例程序" class="headerlink" title="java.util.concurrent 示例程序"></a>java.util.concurrent 示例程序</h3><p><strong>Callable、Future、FutureTask的类图</strong></p><img src="/posts/4b405cfc/62.png" srcset="/img/loading.gif" lazyload style="zoom:67%"><p><strong>示例程序时序图</strong></p><img src="/posts/4b405cfc/63.png" srcset="/img/loading.gif" lazyload alt="image-20200705214631291" style="zoom:50%"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Data</span> &#123;<br>    String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FutureData</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FutureTask</span>&lt;RealData&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Data</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FutureData</span><span class="hljs-params">(Callable&lt;RealData&gt; callable)</span> &#123;<br>        <span class="hljs-built_in">super</span>(callable);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">string</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            get().getContent();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (ExecutionException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> string;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RealData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Data</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String content;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RealData</span><span class="hljs-params">(<span class="hljs-type">int</span> count, <span class="hljs-type">char</span> c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;    making RealData(&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;) BEGIN&quot;</span>);<br>        <span class="hljs-type">char</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[count];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            buffer[i] = c;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">100</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;    making RealData(&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;) END&quot;</span>);<br>        <span class="hljs-built_in">this</span>.content = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> content;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Host</span> &#123;<br>    <span class="hljs-keyword">public</span> FutureData <span class="hljs-title function_">request</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> count, <span class="hljs-keyword">final</span> <span class="hljs-type">char</span> c)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;    request(&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;) BEGIN&quot;</span>);<br><br>        <span class="hljs-type">FutureData</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureData</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;RealData&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> RealData <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealData</span>(count, c);<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-comment">// 启动一个新线程，用于创建RealData的实例。</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(future).start();<br><br>        System.out.println(<span class="hljs-string">&quot;    request(&quot;</span> + count + <span class="hljs-string">&quot;, &quot;</span> + c + <span class="hljs-string">&quot;) END&quot;</span>);<br>        <span class="hljs-keyword">return</span> future;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main BEGIN&quot;</span>);<br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Host</span>();<br>        <span class="hljs-type">FutureData</span> <span class="hljs-variable">data1</span> <span class="hljs-operator">=</span> host.request(<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;A&#x27;</span>);<br>        <span class="hljs-type">FutureData</span> <span class="hljs-variable">data2</span> <span class="hljs-operator">=</span> host.request(<span class="hljs-number">20</span>, <span class="hljs-string">&#x27;B&#x27;</span>);<br>        <span class="hljs-type">FutureData</span> <span class="hljs-variable">data3</span> <span class="hljs-operator">=</span> host.request(<span class="hljs-number">30</span>, <span class="hljs-string">&#x27;C&#x27;</span>);<br><br>        System.out.println(<span class="hljs-string">&quot;main otherJob BEGIN&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">5000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;main otherJob END&quot;</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;data1 = &quot;</span> + data1.get().getContent());<br>            System.out.println(<span class="hljs-string">&quot;data2 = &quot;</span> + data2.get().getContent());<br>            System.out.println(<span class="hljs-string">&quot;data3 = &quot;</span> + data3.get().getContent());<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (ExecutionException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;main END&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Two-Phase-Termination模式"><a href="#Two-Phase-Termination模式" class="headerlink" title="Two-Phase Termination模式"></a>Two-Phase Termination模式</h2><h3 id="定义-9"><a href="#定义-9" class="headerlink" title="定义"></a>定义</h3><p>该模式的名字直译是“分两阶段终止”的意思，它是一种先执行完终止处理再终止线程的模式。</p><img src="/posts/4b405cfc/64.jpg" srcset="/img/loading.gif" lazyload><p>我们称线程在进行正常处理时的状态为“操作中”，在要停止该线程时，会发出“终止请求”，这样，线程不会突然终止，而是会先开始进行“打扫工作”，称为“终止处理中”，是线程终止的第一阶段。</p><p>在“终止处理中”状态下，线程不会在进行正常操作，它虽然仍在运行，但是只会进行终止处理，终止处理完成后，就会真正地终止线程，是线程终止的第二阶段。</p><p>该模式的要点如下。</p><ul><li>安全的终止线程。</li><li>必定会进行终止处理。</li><li>发出终止请求后尽快进行终止处理。</li></ul><h3 id="模式详解-5"><a href="#模式详解-5" class="headerlink" title="模式详解"></a>模式详解</h3><ul><li><p>TerminationRequester（终止请求发出者）<br>TerminationRequester角色负责向Terminator角色发出终止请求，是示例程序中的Main类。</p></li><li><p>Terminator（终止者）<br>Terminator负责接收终止请求，并实际执行终止处理，提供了表示终止请求的shutdownRequest方法。</p><p>当shutdownRequest方法被调用后，Terminator角色会在考虑了安全性的基础上，进入“终止处理中”状态，接着，当终止处理结束后，Terminator角色就会终止自己。</p></li></ul><p>Two-Phase Termination模式的类图</p><img src="/posts/4b405cfc/67.jpg" srcset="/img/loading.gif" lazyload style="zoom:150%"><blockquote><p><strong>NIO与多线程</strong></p><p>java.nio.channels.Channel接口以及实现了该接口的类群的设计中考虑了多线程的问题。</p><p>例如，当一个线程在Channel上发生I&#x2F;O阻塞的时候，其他线程可以close该Channel。这时，发生I&#x2F;O阻塞的线程会接收到AsynchronousCloseException异常。</p><p>另外，当一个线程在Channel上发生I&#x2F;O阻塞的时候，其他线程还可以interrupt该线程。这时，发生I&#x2F;O阻塞的线程会接收到ClosedByInterruptException异常。</p></blockquote><h3 id="示例代码-5"><a href="#示例代码-5" class="headerlink" title="示例代码"></a>示例代码</h3><p><strong>类图</strong></p><img src="/posts/4b405cfc/65.png" srcset="/img/loading.gif" lazyload style="zoom:50%"><p><strong>时序图</strong></p><img src="/posts/4b405cfc/66.png" srcset="/img/loading.gif" lazyload alt="image-20200705220252139" style="zoom:50%"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CountupThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * counter字段表示当前的计数器</span><br><span class="hljs-comment">     * shutdownRequested字段是表示是否已经发出终止请求的标志，该字段的值用于判断线程是否进入“终止处理中”状态</span><br><span class="hljs-comment">     * shutdownRequest方法是表示线程终止请求的方法，当要终止CountupThread的线程时，程序会调用该方法</span><br><span class="hljs-comment">     * 注意，shutdownRequest还调用了interrupt方法，这是为了确保程序在sleep和wait时也会被终止</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">//计数值</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//发出终止请求后变为ture</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">shutdownRequested</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-comment">//终止请求</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdownRequest</span><span class="hljs-params">()</span> &#123;<br>        shutdownRequested = <span class="hljs-literal">true</span>;<br>        interrupt();<br>    &#125;<br><br>    <span class="hljs-comment">//检查是否发出了终止请求</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isShutdownRequested</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> shutdownRequested;<br>    &#125;<br><br>    <span class="hljs-comment">//线程体</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (!isShutdownRequested()) &#123;<br>                doWork();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            doShutdown();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//操作</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doWork</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        counter++;<br>        System.out.println(<span class="hljs-string">&quot;doWork: counter = &quot;</span> + counter);<br>        Thread.sleep(<span class="hljs-number">500</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//终止处理</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doShutdown</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;doShutdown: counter = &quot;</span> + counter);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 启动CountupThread的线程，大约10s后终止该线程</span><br><span class="hljs-comment">     * Thread类的join方法是用户等待线程终止的方法，在指定的线程终止前，join方法不会返回。</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main: Begin&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//启动线程</span><br>            <span class="hljs-type">CountupThread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountupThread</span>();<br>            t.start();<br><br>            <span class="hljs-comment">//稍微间隔一段时间</span><br>            Thread.sleep(<span class="hljs-number">10000</span>);<br><br>            <span class="hljs-comment">//线程的终止请求</span><br>            System.out.println(<span class="hljs-string">&quot;main: shutdownRequest&quot;</span>);<br>            t.shutdownRequest();<br><br>            System.out.println(<span class="hljs-string">&quot;main: join&quot;</span>);<br><br>            <span class="hljs-comment">//等待线程终止</span><br>            t.join();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;main: End&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>java.util.concurrent.ExecutorService接口与Two-phase Termination模式</strong></p><p>ExecutorService使用了Two-phase Termination模式</p><table><thead><tr><th></th><th>isShutdown方法</th><th>isTerminated方法</th></tr></thead><tbody><tr><td>【操作中】</td><td>false</td><td>false</td></tr><tr><td>【终止处理中】</td><td>true</td><td>false</td></tr><tr><td>【终止】</td><td>true</td><td>true</td></tr></tbody></table><h3 id="捕获程序整体的终止"><a href="#捕获程序整体的终止" class="headerlink" title="捕获程序整体的终止"></a>捕获程序整体的终止</h3><h4 id="退出钩子"><a href="#退出钩子" class="headerlink" title="退出钩子"></a>退出钩子</h4><p>退出钩子是指在Java虚拟机退出时启动的线程。”java虚拟机退出时“指的是System.exit()被调用或是全部非守护线程终止时。这时，我们可以使用退出钩子来编写程序完全终止时的终止处理。</p><p>示例程序执行了以下处理：</p><ul><li>设置未捕获的异常的处理器</li><li>设置退出钩子</li><li>大约3秒后启动执行”整数除零计算“的线程</li></ul><p>执行整数除零计算后，程序会抛出java.lang.ArithmeticException异常。由于在示例程序中我们并没有捕获ArithmeticExeception，所以程序会终止。在终止前，”为捕获的异常的处理器“和”退出钩子“会被依次调用。</p><h4 id="未捕获的异常的处理器"><a href="#未捕获的异常的处理器" class="headerlink" title="未捕获的异常的处理器"></a>未捕获的异常的处理器</h4><h4 id="示例代码-6"><a href="#示例代码-6" class="headerlink" title="示例代码"></a>示例代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main:BEGIN&quot;</span>);<br><br>        <span class="hljs-comment">// 设置未捕获的异常的处理器</span><br>        Thread.setDefaultUncaughtExceptionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>.UncaughtExceptionHandler() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uncaughtException</span><span class="hljs-params">(Thread t, Throwable e)</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;\n***********&quot;</span>);<br>                System.out.println(<span class="hljs-string">&quot;UncaughtExceptionHandler:BEGIN&quot;</span>);<br>                System.out.println(<span class="hljs-string">&quot;currentThread = &quot;</span> + Thread.currentThread());<br>                System.out.println(<span class="hljs-string">&quot;thread = &quot;</span> + t);<br>                System.out.println(<span class="hljs-string">&quot;exception = &quot;</span> + e);<br>                System.out.println(<span class="hljs-string">&quot;UncaughtExceptionHandler:END&quot;</span>);<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-comment">// 设置退出钩子</span><br>        Runtime.getRuntime().addShutdownHook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br><br>                System.out.println(<span class="hljs-string">&quot;\n*************&quot;</span>);<br>                System.out.println(<span class="hljs-string">&quot;shutdown hook:BEGIN&quot;</span>);<br>                System.out.println(<span class="hljs-string">&quot;currentThread = &quot;</span> + Thread.currentThread());<br>                System.out.println(<span class="hljs-string">&quot;shutdown hook:END&quot;</span>);<br>            &#125;<br>        &#125;));<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;MyThread:BEGIN&quot;</span>);<br>                System.out.println(<span class="hljs-string">&quot;MyThread:SLEEP...&quot;</span>);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">3000</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br><br>                <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br><br>            <span class="hljs-comment">//    不会来到这里</span><br>                System.out.println(<span class="hljs-string">&quot;MyThread:END&quot;</span>);<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;MyThread&quot;</span>).start();<br><br>        System.out.println(<span class="hljs-string">&quot;main:END&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li><p><strong>Multiphase Cancellation 模式</strong></p><p>使用Multiphase Cancellation模式停止线程时，如果在一定时间内线程没有停止，那么程序会逐渐发出更加强硬的终止请求。</p></li><li><p><strong>Multi-Phase StartUp 模式</strong></p><p>使用Two-Phase Termination模式时，在接收到终止请求后，程序并不立即终止线程，而是先进入”终止处理中“阶段，然后安全的终止线程。</p><p>而使用Multi-Phase StartUp模式时，如果存在多个子系统，则程序会经过多个阶段启动全部系统。在该模式下，系统会定义一个整数值的运行级锁，用来表示当前哪个运行级别正处于启动中状态。</p><p>Java的Applet也使用了该模式，不过它将Multi-Phase StartUp模式缩减至了三步（即创建实例 → 调用init方法 → 调用start方法）。</p></li></ul></blockquote><h3 id="java-util-concurrent-CountDownLatch类"><a href="#java-util-concurrent-CountDownLatch类" class="headerlink" title="java.util.concurrent.CountDownLatch类"></a>java.util.concurrent.CountDownLatch类</h3><p>当我们想让某个线程等待指定的线程终止时，可以使用java.lang.Thread类的join方法。但是，由于join方法可以等待的只是”线程终止“这个一次性的操作，所以我们无法使用它实现”等待指定次数的某种操作发生“。</p><p>使用java.util.concurrent.CountDownLatch类可以实现”等待指定次数的CountDown方法被调用“这一功能。</p><h4 id="示例代码-7"><a href="#示例代码-7" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h4><ul><li>准备一个进行工作的ExecutorService对象（service）</li><li>创建一个CountDownLatch类的实例（doneLatch）。在创建时将初始值TASKS传入CountDownLatch类的构造函数</li><li>调用execute方法执行（在内部启动线程）TASKS 个 MyTask</li><li><strong>调用await方法</strong>等待doneLatch的计数值变为0</li><li><strong>调用shutdown方法终止service</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CountDownLatch doneLatch;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> context;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>(<span class="hljs-number">321234</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyTask</span><span class="hljs-params">(CountDownLatch doneLatch, <span class="hljs-type">int</span> context)</span> &#123;<br>        <span class="hljs-built_in">this</span>.doneLatch = doneLatch;<br>        <span class="hljs-built_in">this</span>.context = context;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        doTask();<br>        doneLatch.countDown();<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doTask</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> Thread.currentThread().getName();<br>        System.out.println(name + <span class="hljs-string">&quot;:MyTask:BEGIN:context = &quot;</span> + context);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(random.nextInt(<span class="hljs-number">3000</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(name + <span class="hljs-string">&quot;:MyTask:END:context = &quot;</span> + context);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TASKS</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>; <span class="hljs-comment">// 工作的个数</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;BEGIN&quot;</span>);<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);<br>        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">doneLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(TASKS);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 开始工作</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; TASKS; i++) &#123;<br>                service.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTask</span>(doneLatch, i));<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;AWAIT&quot;</span>);<br>            <span class="hljs-comment">// 等待工作结束</span><br>            doneLatch.await();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            service.shutdown();<br>            System.out.println(<span class="hljs-string">&quot;END&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a><strong>时序图</strong></h4><img src="/posts/4b405cfc/68.png" srcset="/img/loading.gif" lazyload style="zoom:50%"><h3 id="java-util-concurrent-CyclicBarrier类"><a href="#java-util-concurrent-CyclicBarrier类" class="headerlink" title="java.util.concurrent.CyclicBarrier类"></a>java.util.concurrent.CyclicBarrier类</h3><p>CyclicBarrier可以周期性的创建出屏障。在屏障解除之前，碰到屏障的线程是无法继续前进的。屏障的解除条件是到达屏障处的线程个数达到了构造函数指定的个数。也就是说，当指定个数的线程到达屏障处后，屏障就会被解除，然后这些线程就会像听到了”预备，走“一样一起冲出去。</p><p><strong>在创建CyclicBarrier的实例时，可以指定Runnable对象。这个对象被称作”屏障操作“。每次屏障被解除后，该屏障操作都会被执行。</strong></p><h4 id="示例代码-8"><a href="#示例代码-8" class="headerlink" title="示例代码"></a>示例代码</h4><ul><li>调用doPhase(phase)方法进行第phase阶段的工作</li><li>调用await方法表示自己已经完成了第phase阶段的工作</li><li>当其他所有线程都完成了”第phase阶段的工作“后，run方法从await方法中返回并进入下个阶段的工作</li><li>当所有阶段的工作都完成后，使用doneLatch向主线程发送”工作结束“的消息。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PHASE</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CyclicBarrier phaseBarrier;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CountDownLatch doneLatch;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> context;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>(<span class="hljs-number">32143</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyTask</span><span class="hljs-params">(CyclicBarrier phaseBarrier, CountDownLatch doneLatch, <span class="hljs-type">int</span> context)</span> &#123;<br>        <span class="hljs-built_in">this</span>.phaseBarrier = phaseBarrier;<br>        <span class="hljs-built_in">this</span>.doneLatch = doneLatch;<br>        <span class="hljs-built_in">this</span>.context = context;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">phase</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; phase &lt; PHASE; phase++) &#123;<br>            doPhase(phase);<br>            <span class="hljs-keyword">try</span> &#123;<br>                phaseBarrier.await();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (BrokenBarrierException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                doneLatch.countDown();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPhase</span><span class="hljs-params">(<span class="hljs-type">int</span> phase)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> Thread.currentThread().getName();<br>        System.out.println(name + <span class="hljs-string">&quot;:MyTask:BEGIN:context = &quot;</span> + context + <span class="hljs-string">&quot;, phase = &quot;</span> + phase);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(random.nextInt(<span class="hljs-number">3000</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(name + <span class="hljs-string">&quot;:MyTask:END:context = &quot;</span> + context + <span class="hljs-string">&quot;, phase = &quot;</span> + phase);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">THREADS</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// 线程的个数</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;BEGIN&quot;</span>);<br><br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(THREADS);<br><br>        <span class="hljs-comment">// 屏障被解除时的操作</span><br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">barrierAction</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;Barrier Action!&quot;</span>);<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">// CyclicBarrier用于使线程步骤一致</span><br>        <span class="hljs-type">CyclicBarrier</span> <span class="hljs-variable">phaseBarrier</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CyclicBarrier</span>(THREADS, barrierAction);<br><br>        <span class="hljs-comment">// CountDownLatch用于确认工作是否结束</span><br>        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">doneLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(THREADS);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; THREADS; i++) &#123;<br>                service.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTask</span>(phaseBarrier, doneLatch, i));<br>            &#125;<br><br>            <span class="hljs-comment">// 等待工作结束</span><br>            System.out.println(<span class="hljs-string">&quot;AWAIT&quot;</span>);<br>            doneLatch.await();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            service.shutdown();<br>            System.out.println(<span class="hljs-string">&quot;END&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="时序图-1"><a href="#时序图-1" class="headerlink" title="时序图"></a>时序图</h4><img src="/posts/4b405cfc/69.png" srcset="/img/loading.gif" lazyload alt="image-20200706000509173" style="zoom:50%"><h2 id="Thread-Specific-Storage"><a href="#Thread-Specific-Storage" class="headerlink" title="Thread-Specific Storage"></a>Thread-Specific Storage</h2><h3 id="定义-10"><a href="#定义-10" class="headerlink" title="定义"></a>定义</h3><p>Thread-Specific Storage就是“线程独有的存储库”，该模式会对每个线程提供独有的内存空间。<br>java.lang.ThreadLocal类提供了该模式的实现，ThreadLocal的实例是一种集合（collection）架构，该实例管理了很多对象，可以想象成一个保管有大量保险箱的房间。</p><p>java.lang.ThreadLocal类的方法：</p><ul><li><p>public void set()<br>该方法会检查当前调用线程，默认以该线程的Thread.currentThread()值作为键，来保存指定的值。</p></li><li><p>public Object get()<br>该方法会检查当前调用线程，默认以该线程的Thread.currentThread()值作为键，获取保存指定的值。</p></li></ul><p>Thread-Specific Storage模式还有以下名称。</p><ul><li>Per-Thread Attribute（线程各自的属性）</li><li>Thread-Specific Data（线程特有的数据）</li><li>Thread-Specific Field（线程特有的字段）</li><li>Thread-Local Storage（线程中的局部存储空间）</li></ul><h3 id="模式详解-6"><a href="#模式详解-6" class="headerlink" title="模式详解"></a>模式详解</h3><p>java.lang.ThreadLocal是一个泛型类，可以通过参数的类型来指定要存储的对象的类型。ThreadLocal类的声明大致如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocal</span>&lt;T&gt; &#123;<br>	<span class="hljs-comment">// 存储</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> &#123;<br>		...<br>	&#125;<br>	<br>	<span class="hljs-comment">// 获取</span><br>	<span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>		...<br>	&#125;<br>	...<br>&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th>名字</th><th>说明</th></tr></thead><tbody><tr><td>TSLog</td><td>创建日志的类（实例属于各个线程所有）</td></tr><tr><td>Log</td><td>创建日志的类（分配各个线程）</td></tr><tr><td>java.lang.ThreadLocal</td><td>分配线程持有的存储空间的类</td></tr><tr><td>ClientThread</td><td>表示调用Log的线程的类</td></tr><tr><td>Main</td><td>测试程序行为的类</td></tr></tbody></table><p><strong>角色</strong></p><ul><li><p>Client（委托者）</p><p>Client角色将处理委托给TSObjectProxy角色。一个TSObjectProxy角色会被多个Client角色使用。</p></li><li><p>TSObjectProxy（线程特有的对象的代理人）</p><p>TSObjectProxy角色使用TSObjectCollection角色获取与Client角色对应的TSObject角色。接着，它将处理委托给TSObject角色。</p></li><li><p>TSObjectCollection（线程持有的对象的集合）</p><p>TSObjectCollection角色有一张Client角色与TSObject角色之间的对应表。</p></li><li><p>TSObject（线程特有的对象）</p><p>TSObject角色中保存着线程特有的信息。</p><p>TSObject角色有TSObjectCollection角色管理。<strong>TSObject角色的方法只会被单线程调用</strong>。</p></li></ul><h3 id="类图"><a href="#类图" class="headerlink" title="类图"></a>类图</h3><img src="/posts/4b405cfc/72.png" srcset="/img/loading.gif" lazyload alt="image-20200706205505663" style="zoom:50%"><h3 id="时序图-2"><a href="#时序图-2" class="headerlink" title="时序图"></a>时序图</h3><p><strong>新创建TSObject角色</strong></p><img src="/posts/4b405cfc/73.png" srcset="/img/loading.gif" lazyload alt="image-20200706205538651" style="zoom:50%"><p><strong>多个client角色访问各自的TSObject角色</strong></p><img src="/posts/4b405cfc/74.png" srcset="/img/loading.gif" lazyload alt="image-20200706205843433" style="zoom:50%"><p><strong>示例程序类图</strong></p><img src="/posts/4b405cfc/70.png" srcset="/img/loading.gif" lazyload alt="image-20200706202151734" style="zoom:67%"><p><strong>示例程序TimeThreads图</strong></p><img src="/posts/4b405cfc/71.png" srcset="/img/loading.gif" lazyload alt="image-20200706204459127" style="zoom:50%"><h3 id="示例代码-9"><a href="#示例代码-9" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TSLog</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-comment">// 初始化writer字段</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TSLog</span><span class="hljs-params">(String filename)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            writer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(filename));<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 写日志</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">println</span><span class="hljs-params">(String s)</span> &#123;<br>        writer.println(s);<br>    &#125;<br><br>    <span class="hljs-comment">// 关闭日志</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span> <span class="hljs-params">()</span> &#123;<br>        writer.println(<span class="hljs-string">&quot;=== Enf of log ===&quot;</span>);<br>        writer.close();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Log</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;TSLog&gt; tsLogCollection = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 写日志</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">println</span><span class="hljs-params">(String s)</span> &#123;<br>        getTsLog().println(s);<br>    &#125;<br><br>    <span class="hljs-comment">// 关闭日志</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>        getTsLog().close();<br>    &#125;<br><br>    <span class="hljs-comment">// 获取线程持有的日志</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TSLog <span class="hljs-title function_">getTsLog</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">TSLog</span> <span class="hljs-variable">tsLog</span> <span class="hljs-operator">=</span> tsLogCollection.get();<br><br>        <span class="hljs-keyword">if</span> (tsLog == <span class="hljs-literal">null</span>) &#123;<br>            tsLog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TSLog</span>(Thread.currentThread().getName() + <span class="hljs-string">&quot;-log.txt&quot;</span>);<br>            tsLogCollection.set(tsLog);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> tsLog;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClientThread</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(getName() + <span class="hljs-string">&quot; BEGIN&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            Log.println(<span class="hljs-string">&quot;i= &quot;</span> + i);<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">100</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            Log.close();<br>        &#125;<br>        System.out.println(getName() + <span class="hljs-string">&quot; END&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientThread</span>(<span class="hljs-string">&quot;Alice&quot;</span>).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientThread</span>(<span class="hljs-string">&quot;Bobby&quot;</span>).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientThread</span>(<span class="hljs-string">&quot;Chris&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>保存线程特有信息的位置</p><p>线程特有的信息”保存位置“有以下两种：</p><ul><li><p>线程外</p><p>类似于ThreadLocal这种将线程特有的信息保存在线程外部的方法称为”线程外“。</p></li><li><p>线程内</p><p>如果在线程中声明字段，该字段就是线程特有的信息。这就是在线程内保存线程特有的信息。</p></li></ul></blockquote><h3 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h3><p>与强调吞吐量相比，Thread-Specific Storage模式更看重如下所示的可复用性。</p><ol><li>不改变结构即可实现程序</li><li>没有显式地执行互斥处理，所以编程时犯错的可能性较小</li></ol><blockquote><p><strong>Thread-Specific Storage与Worker Thread模式不能结合使用。</strong></p><p>如果不能确保所有的任务都由不同的线程执行，Thread-Specific Storage模式可能就无法正确工作。这是使用java.lang.ThreadLocal时的一个重要制约条件。</p></blockquote><blockquote><p>在设计多线程角色时，根据以 [ 主体 ] 为主还是以 [ 客体 ] 为主的不同产生了以下两种方式。</p><ul><li><p>基于角色：以主体为主</p><p>所谓基于角色，一言以蔽之即”线程最伟大“的方式。</p><p>基于角色的方式即在表示线程的实例中保存进行工作所必需的信息（上下文、状态）。这样可以减少和减轻线程之间的交互信息量。一个线程会使用从其他线程接收到的信息来执行处理，改变自己的内部状态。通常，我们称这样的线程为角色。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Actor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>	角色的内部状态<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>		循环地从外部接收并执行任务，改变内部状态<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>基于任务：以客体为主</p><p>所谓基于任务，一言以蔽之即”任务最伟大“的方式。</p><p>基于任务的方式不在线程中保存信息（上下文、状态）。在这种方式下，这些信息不保存在线程中，而是保存在线程交互的实例中。而且，不仅是数据，连用于执行请求的方法都定义在其中。像这样在线程之交互的实例可以称为消息、请求或是命令。这里我们暂且称其为任务。由于任务中保存了足够的信息，所以任何线程执行该任务都没有问题。可以说，这是一种富任务往来于轻线程之间的方式。</p><p>使用该方式的一个典型的模式是Worker Thread模式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>	进行工作所必需的信息<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>		工作的处理内容<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>基于任务的示例</p><p>java.util.TimerTask是一个基于任务的类。该类实现了java.lang.Runnable，它会被java.util.Timer类调用。如果要定义一项在一定时间后进行的工作或者定期进行的工作，可以使用java.util.TimerTask类。</p><p>java.util.concurrent.FutureTask类也是一个基于任务的类。该类是Future模式的组成部分，它也实现了java.lang.Runnable。</p></blockquote><h2 id="Active-Object模式"><a href="#Active-Object模式" class="headerlink" title="Active Object模式"></a>Active Object模式</h2><h3 id="定义-11"><a href="#定义-11" class="headerlink" title="定义"></a>定义</h3><p>Active是主动的意思，因此ActiveObject就是主动对象的意思。所谓主动一般指有自己特有的线程，举例来说，java.lang.Thread类的实例就是一种主动对象。</p><p>不过，在Active Object模式中出厂的主动对象可不仅仅有自己特有的线程，它同时还具备可以从外部接收和处理异步消息并根据需要返回处理结果的特征。Active Object模式中的主动对象会通过自己特有的线程在合适的时机处理从外部接收到的异步消息。</p><p>在Active Object中，组成主动对象与许多自然人组成法人类似，即使是java语言这样没有异步消息的编程语言，也可以使用Active Object模式组成实际上能够处理异步消息的主动对象。</p><blockquote><p>在Java中，有一种与Active Object模式相关的技术叫做Remote Method Invocation（远程方法调用，RMI）。RMI是一种可以在本地调用方法，然后网络远端的计算机上执行方法的技术。为了能够在网络间传输对象，RMI使用了Java的序列化（serialization）技术。</p></blockquote><h3 id="模式详解-7"><a href="#模式详解-7" class="headerlink" title="模式详解"></a>模式详解</h3><p><strong>成员一览（粗体字为activeObject包中的public的类和接口）</strong></p><table><thead><tr><th>包</th><th>名字</th><th>说明</th></tr></thead><tbody><tr><td>无名</td><td>Main</td><td>测试程序行为的类</td></tr><tr><td>无名</td><td>MakeClientThread</td><td>发出”生成字符串“请求的线程</td></tr><tr><td>无名</td><td>DisplayClientThread</td><td>发出”显示字符串“请求的线程</td></tr><tr><td>activeObject</td><td><strong>ActiveObject</strong></td><td>定义”主动对象“的接口（API）的接口</td></tr><tr><td>activeObject</td><td><strong>ActiveObjectFactory</strong></td><td>创建”主动对象“的类</td></tr><tr><td>activeObject</td><td>Proxy</td><td>将方法调用转换为MethodRequest对象的类（实现了ActiveObject）的接口</td></tr><tr><td>activeObject</td><td>SchedulerThread</td><td>调用execute方法处理MethodRequest对象的类</td></tr><tr><td>activeObject</td><td>ActivationQueue</td><td>按顺序保存MethodRequest对象的类</td></tr><tr><td>activeObject</td><td>MethodRequest</td><td>表示请求的抽象类</td></tr><tr><td>activeObject</td><td>MakeStringRequest</td><td>makeString方法（生成字符串）对应的类。MethodRequest类的子类</td></tr><tr><td>activeObject</td><td>DisplayStringRequest</td><td>displayString方法（显示字符串）对应的类。MethodRequest类的子类</td></tr><tr><td>activeObject</td><td>Result</td><td>表示执行结果的抽象类</td></tr><tr><td>activeObject</td><td>FutureResult</td><td>在Future模式中表示执行结果的类</td></tr><tr><td>activeObject</td><td>RealResult</td><td>表示实际的执行结果的类</td></tr><tr><td>activeObject</td><td>Servant</td><td>执行实际处理的类（实现了ActiveObject接口）</td></tr></tbody></table><h4 id="角色-1"><a href="#角色-1" class="headerlink" title="角色"></a><strong>角色</strong></h4><ul><li><p>Client（委托者）</p><p>Client角色调用ActiveObject角色的方法来委托处理，它能调用的只有ActiveObject角色提供的方法。调用这些方法后，（如果ActivationQueue角色没有满）程序控制权会立即返回。</p><p>虽然client只知道ActiveObject角色，但它实际上调用的是Proxy角色。</p><p>Client角色在获取处理结果时，会调用VirtualResult角色的getResultValue方法。这里使用了Future模式模式。</p><p>在示例程序1中，由MakerClientThread类和DisplayClientThread类扮演此角色。</p></li><li><p>ActiveObject角色</p><p>ActiveObject角色定义了主动对象向Client角色提供的接口。</p><p>在示例1程序中，由ActiveObject接口扮演此角色。</p></li><li><p>Proxy（代理人）</p><p>Proxy角色负责将方法调用转换为MethodRequest角色的对象。转换后的MethodRequest角色会被传递给Scheduler角色。</p><p>Proxy角色实现了ActiveObject角色提供的接口。</p><p>调用Proxy角色的方法的是Client角色。将方法调用转换为MethodRequest角色，并传递给Scheduler角色的操作都是使用Client角色的线程进行的。</p><p>在示例1程序中，由Proxy类扮演此角色。</p></li><li><p>Scheduler</p><p>Scheduler角色负责将Proxy角色传递过来的MethodRequest角色传递给ActivationQueue角色，以及从ActivationQueue角色去除并执行MethodRequest角色这两项工作。</p><p>Client角色负责将MethodRequest角色传递给ActivationQueue角色。</p><p>而从ActivationQueue角色中取出并执行MethodRequest角色这项工作则是使用Scheduler角色自己的线程进行的。在ActiveObject模式中，<strong>只有使用Client角色和Scheduler角色时才会启动新线程。</strong></p><p>Scheduler角色会把MethodRequest角色放入ActivationQueue角色或者从ActivationQueue角色取出MethodRequest角色。因此，Scheduler角色可以判断下次要执行哪个请求。<strong>如果想实现请求调度的判断逻辑，可以将它们实现在Scheduler角色中。</strong>也正是因为如此，我们才将其命名为Scheduler。</p><p>在示例程序1中，由SchedulerThread类扮演此角色。SchedulerThread并没有进行特殊的调度，而只是执行FIFO（First In First Out）处理。</p></li><li><p>MethodRequest</p><p>MethodRequest角色是来自Client角色的请求对应的角色。MethodRequest定义了负责执行处理的Servant角色，以及负责设置返回值的Future角色和负责执行请求的方法（execute）。</p><p>MethodRequest角色为主动对象的接口赋予了对象的表象形式。</p><p>在示例程序1中，由MethodRequest类扮演此角色。</p></li><li><p>ConcreteMethodRequest</p><p>ConcreteMethodRequest角色是使MethodRequest角色与具体的方法相对应的角色。对于ActiveObject角色中定义的每个方法，会有各个类与之对应。比如MethodAlphaRequest、MethodBetaRequest…。</p><p>在示例程序1中，由MakeStringRequest类和DisplayStringRequest类扮演此角色。其中，MakeStringRequest类对应makeString方法，DisplayStringRequest类对应displayString方法。</p></li><li><p>Servant（仆人）</p><p>Servant角色负责实际地处理请求。</p><p>调用Servant角色的是Scheduler角色的线程。Scheduler角色会从ActivationQueue角色取出一个MethodRequest角色（实际上是ConcreteMethodRequest角色）并执行它。此时，Scheduler角色调用的就是Servant角色的方法。</p><p>Servant角色实现了ActiveObject角色定义的接口。</p><p>Proxy角色会将请求转换为MethodRequest角色，而Servant角色则会实际地执行该请求。Scheduler角色介于Proxy角色和Servant角色之间，负责管理按照什么顺序执行请求。</p><p>在示例程序1中，由Servant类扮演此角色。</p></li><li><p>ActivationQueue（主动队列）</p><p>ActivationQueue角色是保存MethodRequest角色的类。</p><p>调用putRequest方法的是Client角色的线程，而调用takeRequest方法的是Scheduler角色的线程。这里使用了Producer-Consumer模式。</p></li><li><p>VirtualResult（虚拟结果）</p><p>VirtualResult角色与Future角色、RealResult角色共同构成了Future模式。</p><p>Client角色在获取处理结果时会调用VirtualResult角色（实际上是Future角色）的getResultValue方法。</p><p>在示例程序1中，由Result类扮演此角色。</p></li><li><p>Future（期货）</p><p>Future角色是Client角色在获取处理时实际调用的角色。当处理结果还没有出来的时候，它会使用Guarded Suspension模式让Client角色的线程等待结果出来。</p><p>在示例程序1中，由FutureResult类扮演此角色。</p></li><li><p>RealResult（真实结果）</p><p>RealResult角色是表示处理结果的角色。Servant角色会创建一个RealResult角色作为处理结果，然后调用Future角色的setRealResult方法将其设置到Future角色中。</p><p>在示例程序1中，由RealResult类扮演此角色</p></li></ul><h4 id="示例程序1类图"><a href="#示例程序1类图" class="headerlink" title="示例程序1类图"></a><strong>示例程序1类图</strong></h4><img src="/posts/4b405cfc/75.png" srcset="/img/loading.gif" lazyload style="zoom:67%"><h4 id="示例程序1时序图"><a href="#示例程序1时序图" class="headerlink" title="示例程序1时序图"></a><strong>示例程序1时序图</strong></h4><img src="/posts/4b405cfc/76.png" srcset="/img/loading.gif" lazyload style="zoom:67%"><h4 id="示例1代码"><a href="#示例1代码" class="headerlink" title="示例1代码"></a>示例1代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivationQueue</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_METHOD_REQUEST</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MethodRequest[] requestQueue;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> tail; <span class="hljs-comment">// 下次putRequest的位置</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> head; <span class="hljs-comment">// 下次taskRequest的位置</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> count; <span class="hljs-comment">// MethodRequest的数量</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ActivationQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.requestQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodRequest</span>[MAX_METHOD_REQUEST];<br>        <span class="hljs-built_in">this</span>.tail = tail;<br>        <span class="hljs-built_in">this</span>.head = head;<br>        <span class="hljs-built_in">this</span>.count = count;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putRequest</span><span class="hljs-params">(MethodRequest request)</span> &#123;<br>        <span class="hljs-keyword">while</span> (count &gt;= requestQueue.length) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                wait();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        requestQueue[tail] = request;<br>        tail = (tail + <span class="hljs-number">1</span>) % requestQueue.length;<br>        count++;<br>        notifyAll();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> MethodRequest <span class="hljs-title function_">takeRequest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (count &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                wait();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-type">MethodRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> requestQueue[head];<br>        head = (head + <span class="hljs-number">1</span>) % requestQueue.length;<br>        count --;<br>        notifyAll();<br>        <span class="hljs-keyword">return</span> request;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ActiveObject</span> &#123;<br>    Result&lt;String&gt; <span class="hljs-title function_">makeString</span><span class="hljs-params">(<span class="hljs-type">int</span> count, <span class="hljs-type">char</span> fillchar)</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayString</span><span class="hljs-params">(String string)</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActiveObjectFactory</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ActiveObject <span class="hljs-title function_">createActiveObject</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Servant</span> <span class="hljs-variable">servant</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Servant</span>();<br>        <span class="hljs-type">ActivationQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivationQueue</span>();<br>        <span class="hljs-type">SchedulerThread</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SchedulerThread</span>(queue);<br>        <span class="hljs-type">Proxy</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(scheduler, servant);<br>        scheduler.start();<br>        <span class="hljs-keyword">return</span> proxy;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DisplayClientThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ActiveObject activeObject;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DisplayClientThread</span><span class="hljs-params">(String name, ActiveObject activeObject)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name);<br>        <span class="hljs-built_in">this</span>.activeObject = activeObject;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-literal">true</span>; i++) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">string</span> <span class="hljs-operator">=</span> Thread.currentThread().getName() + <span class="hljs-string">&quot; &quot;</span> + i;<br>                activeObject.displayString(string);<br>                Thread.sleep(<span class="hljs-number">200</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DisplayStringRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodRequest</span>&lt;Object&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String string;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DisplayStringRequest</span><span class="hljs-params">(Servant servant, String string)</span> &#123;<br>        <span class="hljs-built_in">super</span>(servant, <span class="hljs-literal">null</span>);<br>        <span class="hljs-built_in">this</span>.string = string;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> &#123;<br>        servant.displayString(string);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FutureResult</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Result</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">private</span> Result&lt;T&gt; result;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">ready</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setResult</span><span class="hljs-params">(Result&lt;T&gt; result)</span> &#123;<br>        <span class="hljs-built_in">this</span>.result = result;<br>        <span class="hljs-built_in">this</span>.ready = <span class="hljs-literal">true</span>;<br>        notifyAll();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> T <span class="hljs-title function_">getResultValue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (!ready) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                wait();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> result.getResultValue();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ActiveObject</span> <span class="hljs-variable">activeObject</span> <span class="hljs-operator">=</span> ActiveObjectFactory.createActiveObject();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MakeClientThread</span>(<span class="hljs-string">&quot;Alice&quot;</span>, activeObject).start();;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MakeClientThread</span>(<span class="hljs-string">&quot;Bobby&quot;</span>, activeObject).start();;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">DisplayClientThread</span>(<span class="hljs-string">&quot;Chris&quot;</span>, activeObject).start();;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MakeClientThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ActiveObject activeObject;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span> fillchar;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MakeClientThread</span><span class="hljs-params">(String name, ActiveObject activeObject)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name);<br>        <span class="hljs-built_in">this</span>.activeObject = activeObject;<br>        <span class="hljs-built_in">this</span>.fillchar = name.charAt(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-literal">true</span>; i++) &#123;<br>                Result&lt;String&gt; result = activeObject.makeString(i, fillchar);<br>                Thread.sleep(<span class="hljs-number">10</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> result.getResultValue();<br>                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;: value = &quot;</span> + value);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MakeStringRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodRequest</span>&lt;String&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> count;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span> fillchar;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MakeStringRequest</span><span class="hljs-params">(Servant servant, FutureResult&lt;String&gt; future, <span class="hljs-type">int</span> count, <span class="hljs-type">char</span> fillchar)</span> &#123;<br>        <span class="hljs-built_in">super</span>(servant, future);<br>        <span class="hljs-built_in">this</span>.count = count;<br>        <span class="hljs-built_in">this</span>.fillchar = fillchar;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> &#123;<br>        Result&lt;String&gt; result = servant.makeString(count, fillchar);<br>        future.setResult(result);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodRequest</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Servant servant;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> FutureResult&lt;T&gt; future;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">MethodRequest</span><span class="hljs-params">(Servant servant, FutureResult&lt;T&gt; future)</span> &#123;<br>        <span class="hljs-built_in">this</span>.servant = servant;<br>        <span class="hljs-built_in">this</span>.future = future;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ActiveObject</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SchedulerThread scheduler;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Servant servant;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Proxy</span><span class="hljs-params">(SchedulerThread scheduler, Servant servant)</span> &#123;<br>        <span class="hljs-built_in">this</span>.scheduler = scheduler;<br>        <span class="hljs-built_in">this</span>.servant = servant;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">makeString</span><span class="hljs-params">(<span class="hljs-type">int</span> count, <span class="hljs-type">char</span> fillchar)</span> &#123;<br>        FutureResult&lt;String&gt; future = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureResult</span>&lt;&gt;();<br>        scheduler.invoke(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MakeStringRequest</span>(servant, future, count, fillchar));<br>        <span class="hljs-keyword">return</span> future;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayString</span><span class="hljs-params">(String string)</span> &#123;<br>        scheduler.invoke(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DisplayStringRequest</span>(servant, string));<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RealResult</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Result</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> T resultValue;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RealResult</span><span class="hljs-params">(T result)</span> &#123;<br>        <span class="hljs-built_in">this</span>.resultValue = result;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getResultValue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> resultValue;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">getResultValue</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SchedulerThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ActivationQueue queue;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SchedulerThread</span><span class="hljs-params">(ActivationQueue queue)</span> &#123;<br>        <span class="hljs-built_in">this</span>.queue = queue;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(MethodRequest request)</span> &#123;<br>        queue.putRequest(request);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">MethodRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> queue.takeRequest();<br>            request.execute();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Servant</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ActiveObject</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">makeString</span><span class="hljs-params">(<span class="hljs-type">int</span> count, <span class="hljs-type">char</span> fillchar)</span> &#123;<br>        <span class="hljs-type">char</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[count];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            buffer[i] = fillchar;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">100</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; make count = &quot;</span> + count + <span class="hljs-string">&quot;, fillchar = &quot;</span> + fillchar + <span class="hljs-string">&quot; complete&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealResult</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayString</span><span class="hljs-params">(String string)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;displayString: &quot;</span> + string);<br>            Thread.sleep(<span class="hljs-number">100</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="类图-1"><a href="#类图-1" class="headerlink" title="类图"></a>类图</h3><img src="/posts/4b405cfc/77.png" srcset="/img/loading.gif" lazyload alt="20200707213425" style="zoom:67%"><h3 id="时序图-3"><a href="#时序图-3" class="headerlink" title="时序图"></a>时序图</h3><img src="/posts/4b405cfc/78.png" srcset="/img/loading.gif" lazyload alt="11111" style="zoom:67%"><h3 id="TimeThreads图"><a href="#TimeThreads图" class="headerlink" title="TimeThreads图"></a>TimeThreads图</h3><img src="/posts/4b405cfc/79.png" srcset="/img/loading.gif" lazyload alt="2222" style="zoom:67%"><h3 id="java-uti-concurrent包于Active-Object模式"><a href="#java-uti-concurrent包于Active-Object模式" class="headerlink" title="java.uti.concurrent包于Active Object模式"></a>java.uti.concurrent包于Active Object模式</h3><p><strong>类和接口一览</strong></p><table><thead><tr><th>包</th><th>类和接口</th><th>内容</th></tr></thead><tbody><tr><td>无名</td><td>Main</td><td>测试程序行为的类</td></tr><tr><td>无名</td><td>MakerClientThread</td><td>委托ActiveObject来生成字符串的线程</td></tr><tr><td>无名</td><td>DisplayClientThread</td><td>委托ACtiveObject来显示字符串的线程</td></tr><tr><td>activeObject</td><td>ActiveObject</td><td>定义主动对象的接口的接口</td></tr><tr><td>activeObject</td><td>ActiveObjectFactory</td><td>创建主动对象的类</td></tr><tr><td>activeObject</td><td>ActiveObjectImpl</td><td>实现了ActiveObject接口的类</td></tr><tr><td>activeObject</td><td>MakeStringRequest</td><td>对应makeString方法（生成字符串）的类</td></tr><tr><td>activeObject</td><td>DisplayStringRequest</td><td>对应DisplayString方法（显示字符串）的类</td></tr></tbody></table><p><strong>使用到的标准类库</strong></p><table><thead><tr><th>类和接口</th><th>内容</th></tr></thead><tbody><tr><td>java.util.concurrent.Executors</td><td>用于获取ExecutorService的工具类</td></tr><tr><td>java.util.concurrent.ExecutorService</td><td>用于提交（submit）请求的接口（替换示例程序中1中的SchedulerThread、ActivationQueue）</td></tr><tr><td>java.util.concurrent.Callable</td><td>将获取返回值的调用（call）抽象化后的接口（替代示例程序1中的MethodRequest）</td></tr><tr><td>java.util.Runnable</td><td>将不获取返回值的调用（run）抽象化后的接口（替代示例程序1中的MethodRequest）</td></tr><tr><td>java.util.concurrent.Future</td><td>表示返回值的接口（替代示例程序1中的Result、FutureResult、RealResult）</td></tr></tbody></table><h4 id="示例程序2的类图"><a href="#示例程序2的类图" class="headerlink" title="示例程序2的类图"></a><strong>示例程序2的类图</strong></h4><img src="/posts/4b405cfc/80.png" srcset="/img/loading.gif" lazyload alt="3333" style="zoom:67%"><h4 id="角色-2"><a href="#角色-2" class="headerlink" title="角色"></a><strong>角色</strong></h4><ul><li><p>Main类</p><p>用于测试程序行为的类。与示例1不同的是可以通过shutdown方法终止。</p></li><li><p>MakerClientThread类<br>MakeClientThread类是调用ActiveObject对象的makeString方法（生成字符串）的线程。<br>于示例程序1不同时，makeString方法的返回值类型是Future&lt;String&gt;。</p></li><li><p>DisplayClientThread类<br>DisplayClientThread类与MakerClientThread类一样，也是表示调用ActiveObject对象的线程的类。</p></li><li><p>ActiveObject接口<br>ActiveObject接口定义了主动对象的接口。<br>与示例程序1不同的是，makeString的返回值类行为Future&lt;String&gt;，而且也增加了shutdown方法。</p></li><li><p>ActiveObjectFactory类<br>ActiveObjectFactory类是用于构成ACtiveObject对象的类。</p><p>于示例程序1不同的是，这里不会组建多个对象，而是仅仅返回ActiveObjectImpl类的实例。这是因为，使用java.util.concurrent包后，类的结构变简单了。</p></li><li><p>ActiveObjectImpl类</p><p>ActiveObjectImpl类是实现了ActiveObject接口的类，它可以进行很多工作。该类与示例程序1中的Proxy和Servant相对应。</p><p>servant字段中保存的是通过Executors.newSingleThreadExecutor方法获取的ExecutorService对象。这样可以确保在这个ExecutorService对象中的背后只有一个线程（通过newSingleThreadExecutor则个名字我们也可以看出来）。</p><p>ExecutorService对象相当于示例程序1中的SchedulerThread类的实例。另外，虽然从表面上看不出来，但是ExecutorService对象的内部保存着一个线程安全的队列，该队列相当于示例程序1中的ActivationQueue类的实例。</p><p>shutdown方法是用于关闭service字段中保存的ExecutorService对象的方法。这样一来，ExecutorService对象就不会再接受新的请求了。</p><p>makeString方法会创建MakeStringRequest类的实例，并submit给ExecutorService对象。</p><p>displayString方法会创建DisplayStringRequest类的实例，并在ExecutorService中execute。</p><p>可以submit和execute的是Callable对象和Runnable对象。MakeStringRequest类实现了Callable接口，而DisplayStringRequest类实现了Runnable接口。</p><h4 id="示例2代码"><a href="#示例2代码" class="headerlink" title="示例2代码"></a>示例2代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ActiveObject</span> &#123;<br>    Future&lt;String&gt; <span class="hljs-title function_">makeString</span><span class="hljs-params">(<span class="hljs-type">int</span> count, <span class="hljs-type">char</span> fillchar)</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayString</span><span class="hljs-params">(String string)</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActiveObjectFactory</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ActiveObject <span class="hljs-title function_">createActiveObject</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActiveObjectImpl</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActiveObjectImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ActiveObject</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();<br><br>    <span class="hljs-comment">// 有返回值的调用</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Future&lt;String&gt; <span class="hljs-title function_">makeString</span><span class="hljs-params">(<span class="hljs-type">int</span> count, <span class="hljs-type">char</span> fillchar)</span> &#123;<br>        <span class="hljs-keyword">class</span> <span class="hljs-title class_">MakeStringRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;String&gt; &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">call</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-type">char</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[count];<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>                        buffer[i] = fillchar;<br>                        Thread.sleep(<span class="hljs-number">100</span>);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 发出请求</span><br>        <span class="hljs-keyword">return</span> service.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MakeStringRequest</span>());<br>    &#125;<br><br>    <span class="hljs-comment">// 没有返回值的调用</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayString</span><span class="hljs-params">(String string)</span> &#123;<br>        <span class="hljs-keyword">class</span> <span class="hljs-title class_">DisplayStringRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    System.out.println(<span class="hljs-string">&quot;displayString: &quot;</span> + string);<br>                    Thread.sleep(<span class="hljs-number">10</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 发出请求</span><br>        service.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DisplayStringRequest</span>());<br>    &#125;<br><br>    <span class="hljs-comment">// 终止服务</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> &#123;<br>        service.shutdown();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DisplayClientThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ActiveObject activeObject;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DisplayClientThread</span><span class="hljs-params">(String name, ActiveObject activeObject)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name);<br>        <span class="hljs-built_in">this</span>.activeObject = activeObject;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-literal">true</span>; i++) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">string</span> <span class="hljs-operator">=</span> Thread.currentThread().getName() + <span class="hljs-string">&quot; &quot;</span> + i;<br>                activeObject.displayString(string);<br>                Thread.sleep(<span class="hljs-number">200</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException e) &#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;:&quot;</span> + e);<br>        &#125; <span class="hljs-keyword">catch</span> (CancellationException e) &#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;:&quot;</span> + e);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;:&quot;</span> + e);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MakerClientThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ActiveObject activeObject;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span> fillchar;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MakerClientThread</span><span class="hljs-params">(String name, ActiveObject activeObject)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name);<br>        <span class="hljs-built_in">this</span>.activeObject = activeObject;<br>        <span class="hljs-built_in">this</span>.fillchar = name.charAt(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-literal">true</span>; i++) &#123;<br>                Future&lt;String&gt; future = activeObject.makeString(i, fillchar);<br>                Thread.sleep(<span class="hljs-number">10</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> future.get();<br>                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;: value = &quot;</span> + value);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException e) &#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;:&quot;</span> + e);<br>        &#125; <span class="hljs-keyword">catch</span> (CancellationException e) &#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;:&quot;</span> + e);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;:&quot;</span> + e);<br>        &#125; <span class="hljs-keyword">catch</span> (ExecutionException e) &#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;:&quot;</span> + e);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ActiveObject</span> <span class="hljs-variable">activeObject</span> <span class="hljs-operator">=</span> ActiveObjectFactory.createActiveObject();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">MakerClientThread</span>(<span class="hljs-string">&quot;Alice&quot;</span>, activeObject).start();<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">MakerClientThread</span>(<span class="hljs-string">&quot;Bobby&quot;</span>, activeObject).start();<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">DisplayClientThread</span>(<span class="hljs-string">&quot;Chris&quot;</span>, activeObject).start();<br>            Thread.sleep(<span class="hljs-number">10000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;**** shutdown ****&quot;</span>);<br>            activeObject.shutdown();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Java/" class="category-chain-item">Java</a> <span>></span> <a href="/categories/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" class="category-chain-item">多线程</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">#多线程</a> <a href="/tags/%E8%AE%BE%E8%AE%A1/">#设计</a></div></div><div class="license-box my-3"><div class="license-title"><div>Java 多线程设计模式</div><div>https://blog.yahyav2rayssr.top/posts/4b405cfc/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Yahya</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年4月16日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/posts/e5b78a2e/" title="Java 多线程入门"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Java 多线程入门</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/9784837e/" title="AQS 原理"><span class="hidden-mobile">AQS 原理</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,t=t.getElementById("subtitle");t&&e&&e(t.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){var t;"tocbot"in window&&(tocbot.refresh(),0!==(t=jQuery("#toc")).length)&&tocbot&&0<t.find(".toc-list-item").length&&t.css("visibility","visible")}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback(function(){if("anchors"in window){anchors.removeAll();var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}})})</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>